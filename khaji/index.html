<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="icon" type="image/png" href="Khaji.png">
    <title>ConnectChat</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100%;
            width: 100%;
            position: fixed;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
        }

        @media (min-width: 769px) {
            body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; position: static; height: 100vh; }
            .container { height: calc(100vh - 40px); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
        }

        /* Toast Notification System */
        .toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: #333; color: white; padding: 12px 20px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px; opacity: 0; transform: translateX(100%);
            transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;
            max-width: 300px;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.error { background: #ff4757; }
        .toast.success { background: #2ed573; }
        .toast.info { background: #667eea; }

        /* Auth Section */
        .auth-section { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; text-align: center; }
        .auth-section h1 { color: white; margin-bottom: 30px; }
        .auth-logo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); background: white; }
        .auth-form { width: 100%; max-width: 350px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .auth-tab { flex: 1; padding: 10px; border: none; background: none; font-weight: 600; color: #888; cursor: pointer; }
        .auth-tab.active { color: #667eea; border-bottom: 2px solid #667eea; margin-bottom: -2px; }
        .input-group { margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .auth-btn:active { opacity: 0.8; }

        /* App Layout */
        .app-section { display: none; height: 100%; width: 100%; }
        .app-container { display: flex; height: 100%; width: 100%; position: relative; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 300px; background: #f9f9f9; border-right: 1px solid #eee; display: flex; flex-direction: column; flex-shrink: 0; height: 100%; }
        .user-profile { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { flex: 1; overflow: hidden; }
        .user-info h3 { font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .logout-btn { background: none; border: none; font-size: 18px; cursor: pointer; opacity: 0.6; }
        .tabs { display: flex; background: white; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 12px 5px; text-align: center; cursor: pointer; font-size: 13px; font-weight: 600; color: #666; }
        .tab.active { color: #667eea; border-bottom: 2px solid #667eea; }
        .tab-content { flex: 1; overflow-y: auto; }
        
        /* User Item Styles */
        .user-item { padding: 12px 15px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; position: relative; }
        .user-item:hover { background: #f0f0f0; }
        .user-item.active { background: #e8eaff; }
        .user-status { width: 8px; height: 8px; border-radius: 50%; background: #4caf50; margin-left: auto; }
        .user-status.offline { background: #ccc; }
        
        /* Unread Badge */
        .unread-badge {
            background: #ff4757; color: white; border-radius: 12px;
            padding: 2px 8px; font-size: 10px; font-weight: bold;
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
        }
        .user-item.has-unread h4 { font-weight: 800; color: #333; }
        .user-item.has-unread p { font-weight: 600; color: #444; }

        .friend-request-badge { background: #ff4757; color: white; border-radius: 10px; padding: 1px 6px; font-size: 10px; margin-left: 5px; }
        .action-btn-sm { border: none; padding: 5px 10px; border-radius: 15px; font-size: 11px; cursor: pointer; margin-left: 5px; }
        .accept-sm { background: #4caf50; color: white; }
        .reject-sm { background: #ff4757; color: white; }
        .add-sm { background: #667eea; color: white; }

        /* Main Chat */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; background: white; min-width: 0; }
        .chat-header { padding: 10px 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; height: 60px; flex-shrink: 0; }
        .back-btn { display: none; background: none; border: none; font-size: 20px; margin-right: 10px; cursor: pointer; }
        .chat-user-info { display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer; min-width: 0; }
        .typing-indicator { font-size: 11px; color: #667eea; font-style: italic; margin-top: 2px; display: none; }
        .call-btns { display: flex; gap: 5px; }
        .call-btn { border: none; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 14px; color: white; }
        .video-btn { background: #4caf50; }
        .audio-btn { background: #2196f3; }
        .call-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 8px; }
        .message { display: flex; flex-direction: column; max-width: 75%; position: relative; }
        .message.sent { align-self: flex-end; }
        .message.received { align-self: flex-start; }
        .message-content { padding: 8px 12px; border-radius: 15px; font-size: 14px; word-wrap: break-word; position: relative; }
        .message.sent .message-content { background: #667eea; color: white; border-bottom-right-radius: 2px; }
        .message.received .message-content { background: white; border: 1px solid #eee; border-bottom-left-radius: 2px; }
        .message.deleted .message-content { background: #f0f0f0; color: #aaa; font-style: italic; border: none; }
        .message-time { font-size: 9px; opacity: 0.7; margin-top: 4px; text-align: right; display: flex; justify-content: flex-end; align-items: center; gap: 4px; }
        .message.sent .message-time { color: rgba(255,255,255,0.8); }
        .status-tick { font-size: 10px; }
        .status-tick.seen { color: #4fc3f7; }
        .message-img { max-width: 100%; max-height: 200px; border-radius: 10px; margin-bottom: 5px; cursor: pointer; display: block; }
        .msg-actions { position: absolute; top: -5px; right: -5px; background: white; border-radius: 10px; padding: 2px; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .message:hover .msg-actions { display: block; }
        .del-btn { border: none; background: none; cursor: pointer; color: #ff4757; font-size: 12px; }

        /* Chat Input */
        .chat-input-area { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .chat-input { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 25px; outline: none; font-size: 15px; }
        .send-btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; }
        .send-btn:disabled { background: #ccc; }
        .img-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: #666; padding: 5px; }
        #imageInput { display: none; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 20px; cursor: pointer; }
        .modal-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .modal-save-btn { width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        
        /* Video Call UI */
        .video-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 2000; display: none; flex-direction: column; }
        .video-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px; align-items: center; position: relative; }
        
        .call-status-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10; color: white;
            transition: opacity 0.3s;
        }
        .call-status-overlay.hidden { opacity: 0; pointer-events: none; }
        .call-status-overlay h2 { margin-bottom: 10px; }
        .call-status-overlay p { opacity: 0.8; }

        .video-box { position: relative; background: #000; border-radius: 10px; overflow: hidden; min-height: 150px; display: flex; align-items: center; justify-content: center; }
        .video-box video { width: 100%; height: 100%; object-fit: cover; }
        .video-label { position: absolute; bottom: 5px; left: 5px; color: white; font-size: 12px; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 10px; }
        
        .call-controls { 
            padding: 15px; display: flex; justify-content: center; gap: 20px; 
            background: rgba(0,0,0,0.8); position: absolute; bottom: 0; left: 0; width: 100%; 
            z-index: 20;
        }
        .control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer; background: rgba(255,255,255,0.2); color: white; display: flex; align-items: center; justify-content: center;}
        .control-btn.end { background: #ff4757; }

        .incoming-call-ui { text-align: center; padding: 30px; }
        .call-actions { display: flex; gap: 20px; justify-content: center; margin-top: 20px; }
        .answer-btn { background: #4caf50; color: white; padding: 10px 30px; border: none; border-radius: 30px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .decline-btn { background: #ff4757; color: white; padding: 10px 30px; border: none; border-radius: 30px; font-size: 16px; font-weight: 600; cursor: pointer; }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            .sidebar { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; transition: transform 0.3s; }
            .main-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; transform: translateX(100%); transition: transform 0.3s; background: white; }
            .app-container.chat-open .sidebar { transform: translateX(-100%); }
            .app-container.chat-open .main-content { transform: translateX(0); }
            .back-btn { display: block; }
            .call-btn { padding: 8px; }
            
            .video-grid { grid-template-columns: 1fr; padding: 0; }
            .video-box { border-radius: 0; }
            .video-box#localVideoBox { 
                position: absolute; top: 20px; right: 20px; width: 100px; height: 140px; 
                border-radius: 10px; border: 2px solid white; z-index: 5;
            }
            .video-box#remoteVideoBox { height: 100%; }
        }
    </style>
</head>
<body>
    <!-- Audio Elements -->
    <!-- Sounds -->
    <audio id="msgSound" src="https://cdn.freesound.org/previews/320/320655_5260872-lq.mp3" preload="auto"></audio>
    <audio id="sentSound" src="https://cdn.freesound.org/previews/411/411411_5121236-lq.mp3" preload="auto"></audio>
    <audio id="ringSound" src="https://cdn.freesound.org/previews/411/411089_5121236-lq.mp3" preload="auto" loop></audio>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        <!-- Auth -->
        <div class="auth-section" id="authSection">
            <img src="Khaji.png" class="auth-logo" alt="Logo">
            <h1>ConnectChat</h1>
            <div class="auth-form">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
                </div>
                <div id="loginForm">
                    <div class="input-group"><input type="email" id="loginEmail" placeholder="Email"></div>
                    <div class="input-group"><input type="password" id="loginPass" placeholder="Password"></div>
                    <button class="auth-btn" onclick="login()">Login</button>
                </div>
                <div id="registerForm" style="display:none;">
                    <div class="input-group"><input type="text" id="regName" placeholder="Name"></div>
                    <div class="input-group"><input type="email" id="regEmail" placeholder="Email"></div>
                    <div class="input-group"><input type="password" id="regPass" placeholder="Password"></div>
                    <button class="auth-btn" onclick="register()">Register</button>
                </div>
            </div>
        </div>

        <!-- App -->
        <div class="app-section" id="appSection">
            <div class="app-container" id="appContainer">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="user-profile" onclick="openModal('profileModal')">
                        <div class="avatar" id="myAvatar">U</div>
                        <div class="user-info">
                            <h3 id="myName">User</h3>
                            <div style="display:flex; align-items:center; gap:5px; margin-top:3px;">
                                <input type="checkbox" id="onlineCheck" checked onchange="toggleStatus()" style="width:12px; height:12px;">
                                <label for="onlineCheck" style="font-size:11px; color:#666;">Online</label>
                            </div>
                        </div>
                        <button class="logout-btn" onclick="logout()">üö™</button>
                    </div>
                    <div class="tabs">
                        <div class="tab active" onclick="loadTab('friends')" id="tabFriends">Friends</div>
                        <div class="tab" onclick="loadTab('requests')" id="tabRequests">Requests <span class="friend-request-badge" id="reqBadge" style="display:none;">0</span></div>
                        <div class="tab" onclick="loadTab('search')" id="tabSearch">Search</div>
                    </div>
                    <div class="tab-content" id="sidebarContent"></div>
                </div>

                <!-- Chat -->
                <div class="main-content">
                    <div class="chat-header">
                        <button class="back-btn" onclick="goBack()">‚¨ÖÔ∏è</button>
                        <div class="chat-user-info" onclick="openModal('friendModal')">
                            <div class="avatar" id="chatAvatar">?</div>
                            <div style="min-width:0">
                                <h3 id="chatName" style="font-size:15px;">Select Friend</h3>
                                <div class="typing-indicator" id="typingDiv">typing...</div>
                            </div>
                        </div>
                        <div class="call-btns">
                            <button class="call-btn video-btn" id="videoCallBtn" onclick="startCall('video')" disabled>üìπ</button>
                            <button class="call-btn audio-btn" id="audioCallBtn" onclick="startCall('audio')" disabled>üé§</button>
                        </div>
                    </div>
                    <div class="chat-messages" id="msgBox">
                        <div style="text-align:center; color:#999; margin-top:50px;">Select a friend to start</div>
                    </div>
                    <div class="chat-input-area">
                        <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
                        <button class="img-btn" onclick="document.getElementById('imageInput').click()">üì∑</button>
                        <input type="text" class="chat-input" id="msgInput" placeholder="Message..." oninput="handleTyping()" onkeypress="if(event.key==='Enter')sendMessage()">
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('profileModal')">&times;</button>
            <h2 style="margin-bottom:15px;">Edit Profile</h2>
            <input type="text" class="modal-input" id="editName" placeholder="Name">
            <input type="text" class="modal-input" id="editBio" placeholder="Bio">
            <input type="text" class="modal-input" id="editStatus" placeholder="Status (e.g., Busy)">
            <button class="modal-save-btn" onclick="saveProfile()">Save</button>
        </div>
    </div>

    <div class="modal-overlay" id="friendModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('friendModal')">&times;</button>
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <div class="avatar" id="friendDetailAvatar" style="width:50px; height:50px;">U</div>
                <div>
                    <h2 id="friendDetailName">Friend</h2>
                    <p id="friendDetailStatus" style="font-size:12px; color:#666;">Status</p>
                </div>
            </div>
            <p style="font-size:13px; color:#666;"><b>Bio:</b> <span id="friendDetailBio">-</span></p>
            <p style="font-size:13px; color:#666; margin-top:5px;"><b>Last Seen:</b> <span id="friendDetailLastSeen">-</span></p>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content" style="max-width:300px; text-align:center;">
            <h3>Delete Message?</h3>
            <p style="font-size:13px; color:#666; margin:15px 0;">This cannot be undone.</p>
            <div style="display:flex; gap:10px;">
                <button class="send-btn" style="flex:1; background:#ccc; color:#333;" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="send-btn" style="flex:1; background:#ff4757;" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="imagePreviewModal" onclick="closeModal('imagePreviewModal')">
        <img id="previewImg" style="max-width:90%; max-height:90%; border-radius:10px;">
    </div>

    <!-- Video Call UI -->
    <div class="video-modal" id="callModal">
        <div class="video-grid">
            <div id="callStatusOverlay" class="call-status-overlay">
                <h2 id="overlayTitle">Calling...</h2>
                <p id="overlayStatus">Ringing</p>
            </div>

            <div class="video-box" id="remoteVideoBox">
                <video id="remoteVid" autoplay playsinline></video>
                <div class="video-label" id="remoteLabel">Friend</div>
            </div>
            <div class="video-box" id="localVideoBox">
                <video id="localVid" autoplay muted playsinline></video>
                <div class="video-label">You</div>
            </div>
        </div>
        <div class="call-controls">
            <button class="control-btn" onclick="toggleMic()">üé§</button>
            <button class="control-btn" onclick="toggleCam()">üìπ</button>
            <button class="control-btn end" onclick="endCall(false)">üìû</button>
        </div>
    </div>

    <!-- Incoming Call UI -->
    <div class="modal-overlay" id="incomingModal">
        <div class="modal-content incoming-call-ui">
            <h2 id="callerName">Caller</h2>
            <p id="callTypeText">Incoming Call...</p>
            <div class="call-actions">
                <button class="decline-btn" onclick="rejectCall()">Reject</button>
                <button class="answer-btn" onclick="answerCall()">Answer</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBtPQ_HcTZtqlPuQ11awTUOIiPjvpMNWlU",
            authDomain: "khaji-23a99.firebaseapp.com",
            databaseURL: "https://khaji-23a99-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "khaji-23a99",
            storageBucket: "khaji-23a99.firebasestorage.app",
            messagingSenderId: "84794766200",
            appId: "1:84794766200:web:207a50412961d45275ce8d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // State
        let me = null, friend = null, chatId = null;
        let currentTab = 'friends';
        let deleteTarget = null;
        let typingTimer = null;
        let unreadCounts = {}; 

        // WebRTC State
        let pc = null; 
        let myStream = null; 
        let callId = null; 
        let callType = null;
        const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // Call Time Tracking
        let callStartTime = null;
        let callStatusListener = null;
        
        // Notification Listener
        let msgListeners = {}; 

        // ----------------- UTILITY FUNCTIONS ----------------- //

        // 1. Toast Notification System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            container.appendChild(toast);

            // Trigger reflow
            setTimeout(() => toast.classList.add('show'), 10);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 2. Sound Player with Interaction Unlock
        function playSound(type) {
            try {
                let audio;
                if(type === 'message') audio = document.getElementById('msgSound');
                else if(type === 'sent') audio = document.getElementById('sentSound');
                else if(type === 'ring') audio = document.getElementById('ringSound');
                
                if (audio) {
                    // Reset time and play
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio play failed (user interaction needed):", e));
                }
            } catch(e) { console.log(e); }
        }
        
        function stopSound() { 
            try {
                const audio = document.getElementById('ringSound');
                audio.pause(); 
                audio.currentTime = 0; 
            } catch(e){} 
        }

        // 3. Browser Notification
        function notifyUser(title, body) {
            if (!("Notification" in window)) return;
            if (Notification.permission === "granted") {
                new Notification(title, { body: body, icon: 'Khaji.png' });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(title, { body: body, icon: 'Khaji.png' });
                    }
                });
            }
        }

        // ----------------- AUTH LOGIC ----------------- //

        auth.onAuthStateChanged(async user => {
            if(user) {
                me = { uid: user.uid, name: user.displayName || "User", email: user.email };
                await db.ref('users/'+me.uid).update({ name: me.name, email: me.email, online: true });
                db.ref('users/'+me.uid+'/online').onDisconnect().set(false);
                db.ref('users/'+me.uid+'/lastSeen').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                
                // Ask for notification permission once logged in
                if (Notification.permission === 'default') Notification.requestPermission();

                showApp();
                listenRequests();
                listenCalls();
            } else {
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
            }
        });

        function switchAuthTab(t) {
            document.querySelectorAll('.auth-tab').forEach(b => b.classList.remove('active'));
            if(t==='login') document.querySelectorAll('.auth-tab')[0].classList.add('active');
            else document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('loginForm').style.display = t==='login'?'block':'none';
            document.getElementById('registerForm').style.display = t==='register'?'block':'none';
        }

        async function login() {
            try { 
                await auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPass').value); 
            } catch(e) { 
                let msg = e.message;
                if(e.code === 'auth/wrong-password' || e.code === 'auth/invalid-login') msg = "Incorrect password. Please try again.";
                if(e.code === 'auth/user-not-found') msg = "User not found.";
                showToast(msg, 'error');
            }
        }
        
        async function register() {
            try {
                const name = document.getElementById('regName').value || "User";
                const cred = await auth.createUserWithEmailAndPassword(document.getElementById('regEmail').value, document.getElementById('regPass').value);
                await cred.user.updateProfile({ displayName: name });
                await db.ref('users/'+cred.user.uid).set({ name, email: cred.user.email, online: true, bio: '', status: 'Hey there!' });
            } catch(e) { 
                showToast(e.message, 'error'); 
            }
        }
        
        function logout() { auth.signOut(); }

        // ----------------- APP LOGIC ----------------- //

        function showApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            document.getElementById('myName').innerText = me.name;
            document.getElementById('myAvatar').innerText = me.name.charAt(0).toUpperCase();
            loadProfile();
            loadTab('friends');
        }

        async function loadProfile() {
            const snap = await db.ref('users/'+me.uid).once('value');
            const d = snap.val();
            if(d) {
                document.getElementById('editName').value = d.name || '';
                document.getElementById('editBio').value = d.bio || '';
                document.getElementById('editStatus').value = d.status || '';
            }
        }
        
        async function saveProfile() {
            const name = document.getElementById('editName').value;
            const bio = document.getElementById('editBio').value;
            const status = document.getElementById('editStatus').value;
            await db.ref('users/'+me.uid).update({ name, bio, status });
            await auth.currentUser.updateProfile({ displayName: name });
            me.name = name;
            document.getElementById('myName').innerText = name;
            document.getElementById('myAvatar').innerText = name.charAt(0);
            closeModal('profileModal');
            showToast('Profile updated!', 'success');
        }
        
        async function toggleStatus() {
            const online = document.getElementById('onlineCheck').checked;
            await db.ref('users/'+me.uid).update({ online, lastSeen: online ? null : firebase.database.ServerValue.TIMESTAMP });
        }

        function loadTab(t) {
            currentTab = t;
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.getElementById('tab'+t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
            if(t==='friends') loadFriends();
            else if(t==='requests') loadRequests();
            else loadSearch();
        }

        // --- FIXED Notification Logic ---
        function setupGlobalListeners(friendIds) {
            // 1. Cleanup old listeners
            Object.keys(msgListeners).forEach(key => msgListeners[key].off());
            msgListeners = {};

            friendIds.forEach(uid => {
                const cid = [me.uid, uid].sort().join('_');
                const ref = db.ref('messages/'+cid).orderByChild('timestamp').limitToLast(1);
                
                msgListeners[uid] = ref;
                let isFirstEvent = true;

                ref.on('child_added', snap => {
                    if (isFirstEvent) { isFirstEvent = false; return; }

                    const msg = snap.val();
                    
                    // If message is not from me
                    if(msg.sender !== me.uid) {
                        // If chat is NOT currently open
                        if(chatId !== cid) {
                            playSound('message');
                            notifyUser("New Message", `From: ${msg.senderName || 'User'}`);
                            
                            if(!unreadCounts[uid]) unreadCounts[uid] = 0;
                            unreadCounts[uid]++;
                            if(currentTab === 'friends') loadFriends();
                        }
                    }
                });
            });
        }

        async function loadFriends() {
            const snap = await db.ref('friendships').orderByChild(me.uid+'/status').equalTo('accepted').once('value');
            const data = snap.val() || {};
            const ids = [];
            Object.keys(data).forEach(k => {
                const f = data[k];
                if(f[me.uid]) ids.push(Object.keys(f).find(x => x !== me.uid));
            });
            
            setupGlobalListeners(ids);
            renderUsers(ids, 'friends');
        }

        async function loadRequests() {
            const snap = await db.ref('friendRequests').orderByChild('to').equalTo(me.uid).once('value');
            const data = snap.val() || {};
            const ids = [], reqData = {};
            Object.keys(data).forEach(k => {
                if(data[k].status === 'pending') {
                    ids.push(data[k].from);
                    reqData[data[k].from] = k;
                }
            });
            const badge = document.getElementById('reqBadge');
            badge.style.display = ids.length > 0 ? 'inline' : 'none';
            badge.innerText = ids.length;
            renderUsers(ids, 'requests', reqData);
        }

        async function loadSearch() {
            const snap = await db.ref('users').once('value');
            const users = snap.val() || {};
            const fSnap = await db.ref('friendships').once('value');
            const fs = fSnap.val() || {};
            const friendIds = [];
            Object.keys(fs).forEach(k => { if(fs[k][me.uid]) friendIds.push(Object.keys(fs[k]).find(x => x !== me.uid)); });
            const rSnap = await db.ref('friendRequests').orderByChild('from').equalTo(me.uid).once('value');
            const rs = rSnap.val() || {};
            const pendingIds = [];
            Object.keys(rs).forEach(k => pendingIds.push(rs[k].to));
            const list = [];
            Object.keys(users).forEach(uid => {
                if(uid !== me.uid && !friendIds.includes(uid) && !pendingIds.includes(uid)) list.push({uid, ...users[uid]});
            });
            renderSearch(list);
        }

        async function renderUsers(ids, type, reqData = {}) {
            const cont = document.getElementById('sidebarContent');
            if(ids.length === 0) {
                cont.innerHTML = `<div style="padding:20px; text-align:center; color:#999;">No ${type}</div>`;
                return;
            }
            let html = '';
            for(let uid of ids) {
                const uSnap = await db.ref('users/'+uid).once('value');
                const u = uSnap.val();
                if(!u) continue;
                const status = u.online ? '' : 'offline';
                const unread = unreadCounts[uid] || 0;
                const unreadClass = unread > 0 ? 'has-unread' : '';
                const unreadBadgeHtml = unread > 0 ? `<div class="unread-badge">${unread}</div>` : '';

                if(type === 'friends') {
                    html += `<div class="user-item ${unreadClass}" onclick="openChat('${uid}')">
                        <div class="avatar">${(u.name||'U').charAt(0)}</div>
                        <div><h4>${u.name}</h4><p style="font-size:11px;color:#888">${u.status||''}</p></div>
                        <div class="user-status ${status}"></div>
                        ${unreadBadgeHtml}
                    </div>`;
                } else if(type === 'requests') {
                    html += `<div class="user-item">
                        <div class="avatar">${(u.name||'U').charAt(0)}</div>
                        <div><h4>${u.name}</h4></div>
                        <button class="action-btn-sm accept-sm" onclick="acceptReq('${uid}', '${reqData[uid]}')">‚úì</button>
                        <button class="action-btn-sm reject-sm" onclick="rejectReq('${reqData[uid]}')">‚úó</button>
                    </div>`;
                }
            }
            cont.innerHTML = html;
        }

        function renderSearch(list) {
            const cont = document.getElementById('sidebarContent');
            if(list.length === 0) {
                cont.innerHTML = `<div style="padding:20px; text-align:center; color:#999;">No users found</div>`;
                return;
            }
            let html = '';
            list.forEach(u => {
                html += `<div class="user-item">
                    <div class="avatar">${(u.name||'U').charAt(0)}</div>
                    <div><h4>${u.name}</h4><p style="font-size:11px;color:#888">${u.email}</p></div>
                    <button class="action-btn-sm add-sm" onclick="addFriend('${u.uid}')">Add</button>
                </div>`;
            });
            cont.innerHTML = html;
        }

        async function addFriend(toUid) {
            await db.ref('friendRequests').push({ from: me.uid, to: toUid, status: 'pending' });
            showToast('Request sent!', 'success');
            loadSearch();
        }
        
        async function acceptReq(uid, key) {
            const fid = [me.uid, uid].sort().join('_');
            await db.ref('friendRequests/'+key).remove();
            await db.ref('friendships/'+fid).set({ [me.uid]: {status:'accepted'}, [uid]: {status:'accepted'} });
            showToast('Friend added!', 'success');
            loadRequests();
        }
        
        async function rejectReq(key) {
            await db.ref('friendRequests/'+key).remove();
            loadRequests();
        }

        function listenRequests() {
            db.ref('friendRequests').orderByChild('to').equalTo(me.uid).on('value', snap => {
                const data = snap.val() || {};
                let count = 0;
                Object.keys(data).forEach(k => { if(data[k].status === 'pending') count++; });
                const badge = document.getElementById('reqBadge');
                badge.style.display = count > 0 ? 'inline' : 'none';
                badge.innerText = count;
            });
        }

        async function openChat(uid) {
            const uSnap = await db.ref('users/'+uid).once('value');
            friend = { uid, ...uSnap.val() };
            chatId = [me.uid, friend.uid].sort().join('_');
            
            unreadCounts[uid] = 0; // Clear count
            
            document.getElementById('chatAvatar').innerText = (friend.name||'U').charAt(0);
            document.getElementById('chatName').innerText = friend.name;
            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('videoCallBtn').disabled = false;
            document.getElementById('audioCallBtn').disabled = false;

            db.ref('chats/'+chatId).set({ [me.uid]: true, [friend.uid]: true });

            if(window.innerWidth <= 768) document.getElementById('appContainer').classList.add('chat-open');
            
            document.getElementById('msgBox').innerHTML = '';
            
            loadMessages();
            listenTyping();
            loadFriends(); // Refresh sidebar
        }

        function goBack() {
            document.getElementById('appContainer').classList.remove('chat-open');
        }

        function loadMessages() {
            db.ref('messages/'+chatId).off();
            
            db.ref('messages/'+chatId).orderByChild('timestamp').on('child_added', async snap => {
                const msg = snap.val();
                const msgId = snap.key;
                
                // Mark as seen logic
                if(msg.sender !== me.uid && msg.status !== 'seen') {
                    db.ref('messages/'+chatId+'/'+msgId).update({status: 'seen'});
                }
                
                renderMessage(msgId, msg);
            });
            
            db.ref('messages/'+chatId).on('child_changed', snap => {
                const msg = snap.val();
                const msgId = snap.key;
                const el = document.getElementById('msg-'+msgId);
                if(el) {
                    if(msg.deleted) {
                        el.querySelector('.message-content').innerHTML = "Message deleted";
                        el.classList.add('deleted');
                    } else if (msg.status === 'seen' && msg.sender === me.uid) {
                        const statusEl = el.querySelector('.status-tick');
                        if(statusEl) {
                            statusEl.innerHTML = '‚úì‚úì';
                            statusEl.classList.add('seen');
                        }
                    }
                }
            });
        }

        function renderMessage(id, msg) {
            const box = document.getElementById('msgBox');
            const sent = msg.sender === me.uid;
            const div = document.createElement('div');
            div.className = `message ${sent ? 'sent' : 'received'}`;
            div.id = 'msg-'+id;
            
            let content = '';
            if(msg.deleted) {
                content = `<div class="message-content" style="background:#eee; color:#888;">Message deleted</div>`;
                div.classList.add('deleted');
            } else if(msg.image) {
                content = `<img src="${msg.image}" class="message-img" onclick="showImage('${msg.image}')">
                          <div class="message-content">${msg.text || ''}</div>`;
            } else {
                content = `<div class="message-content">${msg.text}</div>`;
            }
            
            const time = new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            let statusHtml = '';
            if(sent) {
                if(msg.status === 'seen') statusHtml = '<span class="status-tick seen">‚úì‚úì</span>';
                else statusHtml = '<span class="status-tick">‚úì</span>';
            }
            
            div.innerHTML = `${content}
                <div class="message-time">${time} ${statusHtml} ${sent ? `<span class="msg-actions"><button class="del-btn" onclick="deleteMsg('${id}')">üóëÔ∏è</button></span>` : ''}</div>`;
            
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        async function sendMessage() {
            const text = document.getElementById('msgInput').value.trim();
            if(!text || !chatId) return;
            
            clearTimeout(typingTimer);
            db.ref('typing/'+chatId+'/'+me.uid).remove();
            
            await db.ref('messages/'+chatId).push({
                sender: me.uid, senderName: me.name, text, timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent'
            });
            
            playSound('sent'); // Play sound when sending
            document.getElementById('msgInput').value = '';
        }

        function handleTyping() {
            if(!chatId) return;
            db.ref('typing/'+chatId+'/'+me.uid).set(true);
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => db.ref('typing/'+chatId+'/'+me.uid).remove(), 2000);
        }
        
        function listenTyping() {
            if(!chatId) return;
            db.ref('typing/'+chatId).on('value', snap => {
                const data = snap.val();
                const div = document.getElementById('typingDiv');
                if(data && data[friend.uid]) div.style.display = 'block';
                else div.style.display = 'none';
            });
        }

        async function handleImageUpload(e) {
            const file = e.target.files[0];
            if(!file || !chatId) return;
            try {
                showToast('Uploading image...', 'info');
                const path = `chat_images/${chatId}/${Date.now()}_${file.name}`;
                const ref = storage.ref(path);
                await ref.put(file);
                const url = await ref.getDownloadURL();
                await db.ref('messages/'+chatId).push({
                    sender: me.uid, image: url, text: '', timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent'
                });
                playSound('sent');
                showToast('Image sent!', 'success');
            } catch(err) {
                console.error(err);
                showToast('Image upload failed: ' + err.message, 'error');
            }
            e.target.value = '';
        }

        function showImage(src) {
            document.getElementById('previewImg').src = src;
            openModal('imagePreviewModal');
        }

        function deleteMsg(id) {
            deleteTarget = id;
            openModal('deleteModal');
        }
        
        async function confirmDelete() {
            if(!deleteTarget) return;
            await db.ref('messages/'+chatId+'/'+deleteTarget).update({ deleted: true, text: '', image: '' });
            closeModal('deleteModal');
            deleteTarget = null;
        }

        /* --- WEBRTC CALL LOGIC --- */
        
        function createPeerConnection() {
            pc = new RTCPeerConnection(servers);
            if(myStream) myStream.getTracks().forEach(track => pc.addTrack(track, myStream));
            
            pc.ontrack = (event) => {
                document.getElementById('remoteVid').srcObject = event.streams[0];
            };
            return pc;
        }

        function setCallUI(status, text) {
            const overlay = document.getElementById('callStatusOverlay');
            const title = document.getElementById('overlayTitle');
            const statusText = document.getElementById('overlayStatus');

            if (status === 'calling') {
                overlay.className = "call-status-overlay"; // show
                title.innerText = "Calling " + friend.name;
                statusText.innerText = "Ringing...";
            } else if (status === 'connected') {
                overlay.className = "call-status-overlay hidden"; // hide
            } else if (status === 'ended') {
                overlay.className = "call-status-overlay"; // show
                title.innerText = "Call Ended";
                statusText.innerText = text || "Call duration: 0m 0s";
            }
        }

        async function startCall(type) {
            callType = type;
            callId = Date.now().toString();
            
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
                document.getElementById('localVid').srcObject = myStream;
                document.getElementById('remoteLabel').innerText = friend.name; 
                
                openModal('callModal');
                setCallUI('calling'); 

                createPeerConnection();
                
                pc.onicecandidate = (event) => {
                    if(event.candidate) db.ref(`calls/${callId}/callerCandidates`).push(event.candidate.toJSON());
                };

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                await db.ref('calls/'+callId).set({
                    caller: me.uid, callee: friend.uid, type: type,
                    offer: { type: offer.type, sdp: offer.sdp },
                    status: 'ringing', timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                listenForCallStatus();

                db.ref(`calls/${callId}/answer`).on('value', async (snapshot) => {
                    const data = snapshot.val();
                    if(data && !pc.currentRemoteDescription) {
                        await pc.setRemoteDescription(new RTCSessionDescription(data));
                    }
                });
                
                db.ref(`calls/${callId}/calleeCandidates`).on('child_added', async (snapshot) => {
                    if(snapshot.val()) await pc.addIceCandidate(new RTCIceCandidate(snapshot.val()));
                });

            } catch(err) {
                showToast("Could not start call: " + err.message, 'error');
                endCall(true); 
            }
        }

        function listenCalls() {
            db.ref('calls').orderByChild('callee').equalTo(me.uid).on('child_added', async snap => {
                const call = snap.val();
                if(call.status === 'ringing') {
                    callId = snap.key;
                    callType = call.type;
                    
                    const uSnap = await db.ref('users/'+call.caller).once('value');
                    const caller = uSnap.val();
                    
                    document.getElementById('callerName').innerText = caller.name;
                    document.getElementById('callTypeText').innerText = `Incoming ${call.type} call...`;
                    
                    playSound('ring');
                    openModal('incomingModal');
                }
            });
        }

        async function answerCall() {
            stopSound();
            closeModal('incomingModal');
            
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: callType === 'video', audio: true });
                document.getElementById('localVid').srcObject = myStream;
                
                const callSnap = await db.ref('calls/'+callId).once('value');
                const callerId = callSnap.val().caller;
                const uSnap = await db.ref('users/'+callerId).once('value');
                document.getElementById('remoteLabel').innerText = uSnap.val().name;

                openModal('callModal');
                setCallUI('connected'); 
                
                createPeerConnection();

                pc.onicecandidate = (event) => {
                    if(event.candidate) db.ref(`calls/${callId}/calleeCandidates`).push(event.candidate.toJSON());
                };

                if(callSnap.val().offer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(callSnap.val().offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    
                    await db.ref(`calls/${callId}/answer`).set({ type: answer.type, sdp: answer.sdp });
                    await db.ref(`calls/${callId}`).update({status: 'connected'});
                }

                db.ref(`calls/${callId}/callerCandidates`).on('child_added', async (snapshot) => {
                    if(snapshot.val()) await pc.addIceCandidate(new RTCIceCandidate(snapshot.val()));
                });

                listenForCallStatus();

            } catch(err) {
                showToast("Could not answer call: " + err.message, 'error');
                endCall(true);
            }
        }

        function listenForCallStatus() {
            if(callStatusListener) db.ref('calls/'+callId).off('value', callStatusListener);
            
            callStatusListener = db.ref('calls/'+callId).on('value', (snapshot) => {
                const data = snapshot.val();
                if(!data) return;

                if(data.status === 'connected') {
                    callStartTime = Date.now();
                    setCallUI('connected');
                }
                
                if(data.status === 'ended' || data.status === 'rejected') {
                    endCall(true); 
                }
            });
        }

        async function endCall(isRemoteEnd) {
            let durationStr = "";
            if (callStartTime) {
                const diff = Math.floor((Date.now() - callStartTime) / 1000);
                const m = Math.floor(diff / 60);
                const s = diff % 60;
                durationStr = `${m}m ${s}s`;
            }

            // Show Call Ended UI briefly if not remote end
            if(!isRemoteEnd && callId) {
                setCallUI('ended', durationStr);
                await db.ref('calls/'+callId).update({status: 'ended'});
                await new Promise(r => setTimeout(r, 1500)); // Wait 1.5s to show "Call Ended"
            }

            closeModal('callModal');
            closeModal('incomingModal');
            stopSound();
            
            if(pc) { pc.close(); pc = null; }
            if(myStream) { myStream.getTracks().forEach(t => t.stop()); myStream = null; }
            
            if(callStatusListener) db.ref('calls/'+callId).off('value', callStatusListener);
            
            callStartTime = null;
            callId = null;
        }

        async function rejectCall() {
            stopSound();
            if(callId) await db.ref(`calls/${callId}`).update({status: 'rejected'});
            closeModal('incomingModal');
            callId = null;
        }

        function toggleMic() { if(myStream) myStream.getAudioTracks()[0].enabled = !myStream.getAudioTracks()[0].enabled; }
        function toggleCam() { if(myStream && myStream.getVideoTracks().length > 0) myStream.getVideoTracks()[0].enabled = !myStream.getVideoTracks()[0].enabled; }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
    </script>
</body>
</html>
