<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Khaji Chat - Authentication</title>
  
  <!-- Google Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 40px;
      width: 100%;
      max-width: 440px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo-area {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-area h1 {
      font-size: 36px;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .logo-area p {
      color: #666;
      font-size: 15px;
    }

    .tab-container {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: #f0f0f0;
      padding: 5px;
      border-radius: 14px;
    }

    .tab-btn {
      flex: 1;
      padding: 14px;
      border: none;
      background: transparent;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #666;
    }

    .tab-btn.active {
      background: white;
      color: #667eea;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }

    .input-wrapper {
      position: relative;
    }

    .input-wrapper .material-icons {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-size: 20px;
    }

    .input-wrapper input {
      width: 100%;
      padding: 16px 20px 16px 50px;
      border: 2px solid #e0e0e0;
      border-radius: 14px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: white;
      font-family: 'Inter', sans-serif;
    }

    .input-wrapper input:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
    }

    .toggle-password {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #999;
      z-index: 2;
    }

    .toggle-password:hover {
      color: #667eea;
    }

    .main-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      font-family: 'Inter', sans-serif;
    }

    .main-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .main-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .main-btn.loading {
      position: relative;
      color: transparent;
    }

    .main-btn.loading::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      border: 3px solid white;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .message-area {
      margin: 20px 0;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      display: none;
    }

    .message-area.show {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .error-msg {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #c62828;
    }

    .success-msg {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #2e7d32;
    }

    .hidden {
      display: none !important;
    }

    .demo-credentials {
      margin-top: 25px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      font-size: 13px;
      color: #666;
      text-align: center;
      border: 1px dashed #667eea;
    }

    .demo-credentials p {
      margin: 5px 0;
      font-family: monospace;
      background: white;
      padding: 8px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="logo-area">
      <h1>‚ú® Khaji Chat</h1>
      <p>Connect with friends through text and video</p>
    </div>

    <!-- Tab Switcher -->
    <div class="tab-container">
      <button id="login-tab" class="tab-btn active" onclick="switchTab('login')">Login</button>
      <button id="register-tab" class="tab-btn" onclick="switchTab('register')">Register</button>
    </div>

    <!-- Message Area -->
    <div id="message-area" class="message-area"></div>

    <!-- Form -->
    <form id="auth-form" onsubmit="return false;">
      <!-- Username Field (Register only) -->
      <div id="username-group" class="form-group hidden">
        <label for="username">Username</label>
        <div class="input-wrapper">
          <span class="material-icons">person_outline</span>
          <input type="text" id="username" placeholder="Choose a username" autocomplete="off">
        </div>
      </div>

      <!-- Email Field -->
      <div class="form-group">
        <label for="email">Email Address</label>
        <div class="input-wrapper">
          <span class="material-icons">mail_outline</span>
          <input type="email" id="email" placeholder="Enter your email" value="lamaproject2026@gmail.com" autocomplete="off">
        </div>
      </div>

      <!-- Password Field -->
      <div class="form-group">
        <label for="password">Password</label>
        <div class="input-wrapper">
          <span class="material-icons">lock_outline</span>
          <input type="password" id="password" placeholder="Enter your password" value="password123" autocomplete="off">
          <span class="material-icons toggle-password" onclick="togglePassword()">visibility_off</span>
        </div>
      </div>

      <!-- Action Button -->
      <button type="button" id="main-btn" class="main-btn" onclick="handleAuth()">
        <span class="btn-text">Login</span>
      </button>
    </form>

    <!-- Demo Credentials -->
    <div class="demo-credentials">
      <strong>üìù Demo Credentials:</strong>
      <p>Email: lamaproject2026@gmail.com</p>
      <p>Password: password123</p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase directly
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword,
      setPersistence,
      browserLocalPersistence 
    } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { 
      getFirestore, 
      doc, 
      setDoc,
      serverTimestamp 
    } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBtPQ_HcTZtqlPuQ11awTUOIiPjvpMNWlU",
      authDomain: "khaji-23a99.firebaseapp.com",
      databaseURL: "https://khaji-23a99-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "khaji-23a99",
      storageBucket: "khaji-23a99.firebasestorage.app",
      messagingSenderId: "84794766200",
      appId: "1:84794766200:web:207a50412961d45275ce8d",
      measurementId: "G-2RE1L7HQTZ"
    };

    // Initialize Firebase with error handling
    let app, auth, db;
    
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      
      // Set persistence
      await setPersistence(auth, browserLocalPersistence);
      
      console.log('‚úÖ Firebase initialized successfully');
    } catch (error) {
      console.error('‚ùå Firebase initialization error:', error);
      showMessage('Failed to initialize Firebase. Please check your connection.', 'error');
    }

    // DOM Elements
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const usernameInput = document.getElementById('username');
    const usernameGroup = document.getElementById('username-group');
    const mainBtn = document.getElementById('main-btn');
    const btnText = mainBtn.querySelector('.btn-text');
    const messageArea = document.getElementById('message-area');
    const loginTab = document.getElementById('login-tab');
    const registerTab = document.getElementById('register-tab');

    let isLoginMode = true;

    // Make functions globally available
    window.switchTab = function(mode) {
      isLoginMode = (mode === 'login');
      
      // Update Tab Styles
      loginTab.classList.toggle('active', isLoginMode);
      registerTab.classList.toggle('active', !isLoginMode);
      
      // Show/Hide Username field
      usernameGroup.classList.toggle('hidden', isLoginMode);
      
      // Update Button Text
      btnText.textContent = isLoginMode ? 'Login' : 'Create Account';
      
      // Clear messages
      clearMessage();
    }

    window.handleAuth = async function() {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const username = usernameInput.value.trim();

      // Basic Validation
      if (!email || !password) {
        showMessage('Please fill in all fields.', 'error');
        return;
      }

      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showMessage('Please enter a valid email address.', 'error');
        return;
      }

      if (!isLoginMode && !username) {
        showMessage('Please choose a username.', 'error');
        return;
      }

      if (!isLoginMode && password.length < 6) {
        showMessage('Password must be at least 6 characters.', 'error');
        return;
      }

      setLoading(true);

      try {
        if (isLoginMode) {
          // --- LOGIN ---
          console.log('Attempting login with:', email);
          const userCred = await signInWithEmailAndPassword(auth, email, password);
          console.log('‚úÖ Login successful:', userCred.user.email);
          
          showMessage('Login successful! Redirecting...', 'success');
          
          // Update online status
          if (db) {
            await setDoc(doc(db, "users", userCred.user.uid), {
              email: email,
              isOnline: true,
              lastSeen: serverTimestamp()
            }, { merge: true });
          }
          
          setTimeout(() => {
            window.location.href = "chat.html";
          }, 1500);
        } else {
          // --- REGISTER ---
          console.log('Attempting registration with:', email);
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          console.log('‚úÖ Registration successful:', userCred.user.email);
          
          // Save to Firestore
          if (db) {
            await setDoc(doc(db, "users", userCred.user.uid), {
              username: username,
              email: email,
              createdAt: serverTimestamp(),
              isOnline: true,
              lastSeen: serverTimestamp(),
              uid: userCred.user.uid
            });
          }
          
          showMessage('Account created successfully! Redirecting...', 'success');
          setTimeout(() => {
            window.location.href = "chat.html";
          }, 1500);
        }
      } catch (error) {
        console.error('‚ùå Auth error:', error.code, error.message);
        setLoading(false);
        
        let msg = "An error occurred. Please try again.";
        
        switch(error.code) {
          case 'auth/email-already-in-use':
            msg = "This email is already registered. Please login instead.";
            break;
          case 'auth/invalid-email':
            msg = "Please enter a valid email address.";
            break;
          case 'auth/weak-password':
            msg = "Password should be at least 6 characters.";
            break;
          case 'auth/user-not-found':
            msg = "No account found with this email. Please register first.";
            break;
          case 'auth/wrong-password':
            msg = "Incorrect password. Please try again.";
            break;
          case 'auth/too-many-requests':
            msg = "Too many failed attempts. Please try again later.";
            break;
          case 'auth/network-request-failed':
            msg = "Network error. Please check your internet connection.";
            break;
          default:
            msg = error.message;
        }
        
        showMessage(msg, 'error');
      }
    }

    window.togglePassword = function() {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      const toggleIcon = document.querySelector('.toggle-password');
      toggleIcon.textContent = type === 'password' ? 'visibility_off' : 'visibility';
    }

    function setLoading(state) {
      mainBtn.disabled = state;
      mainBtn.classList.toggle('loading', state);
    }

    function showMessage(msg, type) {
      messageArea.textContent = msg;
      messageArea.className = `message-area show ${type}-msg`;
    }

    function clearMessage() {
      messageArea.textContent = '';
      messageArea.className = 'message-area';
    }

    // Enter key handler
    document.getElementById('auth-form').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleAuth();
      }
    });

    // Test Firebase connection
    async function testFirebase() {
      try {
        console.log('Testing Firebase connection...');
        console.log('Auth object:', auth ? '‚úÖ Available' : '‚ùå Not available');
        console.log('Firestore object:', db ? '‚úÖ Available' : '‚ùå Not available');
      } catch (error) {
        console.error('Firebase test failed:', error);
      }
    }

    testFirebase();
  </script>
</body>
</html>
