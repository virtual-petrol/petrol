<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Khaji Social</title>

<script src="https://cdn.tailwindcss.com"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore, collection, addDoc, onSnapshot,
  query, doc, setDoc, getDoc, getDocs,
  updateDoc, arrayUnion, arrayRemove,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "PASTE_YOUR_KEY",
  authDomain: "PASTE_YOUR_DOMAIN",
  projectId: "PASTE_YOUR_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------------- GLOBAL VAR ---------------- */
let currentUser = null;
let currentUserData = null;

/* ---------------- AUTH ---------------- */
window.register = async () => {
  const name = regName.value.trim();
  const email = regEmail.value.trim();
  const pass = regPass.value.trim();

  if(!name || !email || !pass) return alert("Fill all fields");

  const cred = await createUserWithEmailAndPassword(auth, email, pass);

  await setDoc(doc(db,"users",cred.user.uid),{
    uid:cred.user.uid,
    name,
    email,
    photoURL:`https://ui-avatars.com/api/?name=${name}&background=1877f2&color=fff`,
    friends:[],
    requests:[]
  });
};

window.login = async () => {
  await signInWithEmailAndPassword(auth,loginEmail.value,loginPass.value);
};

window.logout = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, async (user)=>{
  if(user){
    loginView.classList.add("hidden");
    appView.classList.remove("hidden");

    currentUser=user;
    const snap=await getDoc(doc(db,"users",user.uid));
    currentUserData=snap.data();

    userName.innerText=currentUserData.name;
    userPic.src=currentUserData.photoURL;

    loadPosts();
    loadFriends();
  }else{
    loginView.classList.remove("hidden");
    appView.classList.add("hidden");
  }
});

/* ---------------- POST ---------------- */
window.createPost = async ()=>{
  const text=postInput.value.trim();
  if(!text) return alert("Write something");

  await addDoc(collection(db,"posts"),{
    text,
    uid:currentUser.uid,
    userName:currentUserData.name,
    userPhoto:currentUserData.photoURL,
    createdAt:new Date(),
    likes:[]
  });

  postInput.value="";
};

function loadPosts(){
  const q=query(collection(db,"posts"),orderBy("createdAt","desc"));

  onSnapshot(q,(snap)=>{
    posts.innerHTML="";
    snap.forEach(docSnap=>{
      const p=docSnap.data();
      const liked=p.likes.includes(currentUser.uid);

      posts.innerHTML+=`
      <div class="bg-white p-4 rounded shadow mb-3">
        <div class="flex items-center gap-2 mb-2">
          <img src="${p.userPhoto}" class="w-10 h-10 rounded-full">
          <h3 class="font-semibold">${p.userName}</h3>
        </div>
        <p>${p.text}</p>
        <button onclick="toggleLike('${docSnap.id}',${liked})"
          class="${liked?'text-blue-600 font-bold':''}">
          üëç Like (${p.likes.length})
        </button>
      </div>`;
    });
  });
}

window.toggleLike=async(id,liked)=>{
  const ref=doc(db,"posts",id);
  if(liked)
    await updateDoc(ref,{likes:arrayRemove(currentUser.uid)});
  else
    await updateDoc(ref,{likes:arrayUnion(currentUser.uid)});
};

/* ---------------- SEARCH FRIEND ---------------- */
window.searchFriend=async()=>{
  const term=searchInput.value.toLowerCase();
  searchResults.innerHTML="";
  if(!term) return;

  const snap=await getDocs(collection(db,"users"));
  snap.forEach(d=>{
    const u=d.data();
    if(u.uid!==currentUser.uid && u.name.toLowerCase().includes(term)){
      const isFriend=currentUserData.friends.includes(u.uid);
      searchResults.innerHTML+=`
      <div class="flex justify-between p-2 bg-gray-100 rounded mb-1">
        <span>${u.name}</span>
        ${isFriend?
          `<span class="text-green-600 text-xs">Friend</span>`:
          `<button onclick="sendReq('${u.uid}')"
            class="text-xs bg-blue-600 text-white px-2 py-1 rounded">
            Add
          </button>`
        }
      </div>`;
    }
  });
};

window.sendReq=async(uid)=>{
  await updateDoc(doc(db,"users",uid),{
    requests:arrayUnion({
      uid:currentUser.uid,
      name:currentUserData.name
    })
  });
  alert("Request Sent");
};

/* ---------------- FRIEND LIST ---------------- */
function loadFriends(){
  onSnapshot(doc(db,"users",currentUser.uid),async(snap)=>{
    currentUserData=snap.data();
    friendList.innerHTML="";
    for(let fid of currentUserData.friends){
      const fs=await getDoc(doc(db,"users",fid));
      friendList.innerHTML+=`
      <div class="p-2 bg-gray-200 rounded mb-1">
        ${fs.data().name}
      </div>`;
    }
  });
}
</script>
</head>

<body class="bg-gray-100">

<!-- LOGIN -->
<div id="loginView" class="p-10">
<h2 class="text-2xl mb-3">Login</h2>
<input id="loginEmail" placeholder="Email" class="border p-2 mb-2 block">
<input id="loginPass" type="password" placeholder="Password" class="border p-2 mb-2 block">
<button onclick="login()" class="bg-blue-600 text-white px-4 py-2">Login</button>

<hr class="my-4">

<h2 class="text-2xl mb-3">Register</h2>
<input id="regName" placeholder="Name" class="border p-2 mb-2 block">
<input id="regEmail" placeholder="Email" class="border p-2 mb-2 block">
<input id="regPass" type="password" placeholder="Password" class="border p-2 mb-2 block">
<button onclick="register()" class="bg-green-600 text-white px-4 py-2">Register</button>
</div>

<!-- APP -->
<div id="appView" class="hidden p-6">

<div class="flex justify-between mb-6">
<div class="flex items-center gap-2">
<img id="userPic" class="w-10 h-10 rounded-full">
<span id="userName"></span>
</div>
<button onclick="logout()" class="bg-red-600 text-white px-3 py-1">Logout</button>
</div>

<div class="mb-6">
<input id="postInput" placeholder="What's on your mind?" class="border p-2 w-full mb-2">
<button onclick="createPost()" class="bg-blue-600 text-white px-4 py-2">Post</button>
</div>

<div id="posts"></div>

<hr class="my-6">

<h3 class="font-bold mb-2">Search Friend</h3>
<input id="searchInput" oninput="searchFriend()" class="border p-2 w-full mb-2">
<div id="searchResults"></div>

<hr class="my-6">

<h3 class="font-bold mb-2">Friends</h3>
<div id="friendList"></div>

</div>

</body>
</html>
