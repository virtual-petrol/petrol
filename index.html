<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ConnectChat - Friend Requests & Video Calls</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 0;
            box-shadow: none;
            min-height: 100vh;
        }

        /* Mobile First Approach */
        @media (min-width: 768px) {
            .container {
                width: 95%;
                margin: 20px auto;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                min-height: auto;
            }
        }

        /* Login/Register Section */
        .auth-section {
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .auth-section {
                min-height: auto;
                padding: 40px;
            }
        }

        .auth-section h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        @media (min-width: 768px) {
            .auth-section h1 {
                font-size: 2.5em;
            }
        }

        .auth-form {
            max-width: 400px;
            margin: 20px auto 0;
            width: 100%;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 50px;
            padding: 5px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 25px;
            background: white;
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            margin-top: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        /* Main App Section */
        .app-section {
            display: none;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100%;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
                height: 600px;
            }
        }

        /* Mobile Sidebar */
        .mobile-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }

        @media (min-width: 768px) {
            .mobile-header {
                display: none;
            }
        }

        .menu-btn {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #667eea;
            padding: 5px;
        }

        .mobile-title {
            flex: 1;
            text-align: center;
            font-weight: 600;
            color: #333;
        }

        .mobile-sidebar {
            position: fixed;
            top: 0;
            left: -100%;
            width: 85%;
            max-width: 300px;
            height: 100vh;
            background: #f5f5f5;
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .mobile-sidebar.open {
            left: 0;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .sidebar-overlay.open {
            display: block;
        }

        @media (min-width: 768px) {
            .mobile-sidebar {
                position: static;
                width: 300px;
                height: auto;
                left: 0;
                box-shadow: none;
            }
            
            .sidebar-overlay {
                display: none !important;
            }
            
            .mobile-header {
                display: none;
            }
        }

        .sidebar {
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .user-profile {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .user-profile:hover {
            background: #f0f0f0;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-info h3 {
            font-size: 16px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-info p {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .status-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .status-toggle label {
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        .logout-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            flex-shrink: 0;
        }

        .logout-btn:hover {
            color: #f44336;
        }

        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 15px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
            position: relative;
        }

        @media (min-width: 768px) {
            .tab {
                padding: 15px;
                font-size: 16px;
            }
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .friend-request-badge {
            background: #f44336;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }

        .user-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.3s;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        @media (min-width: 768px) {
            .user-item {
                padding: 15px 20px;
            }
        }

        .user-item:hover {
            background: #e8e8e8;
        }

        .user-item.active {
            background: #e3e3e3;
        }

        .user-item.unread {
            background-color: #fff3e0;
        }

        .user-item.unread .user-info h4 {
            font-weight: 800;
            color: #000;
        }

        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            margin-left: auto;
            flex-shrink: 0;
        }

        .user-status.offline {
            background: #9e9e9e;
        }

        .message-count {
            background: #f44336;
            color: white;
            border-radius: 50%;
            min-width: 22px;
            height: 22px;
            padding: 0 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            flex-shrink: 0;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        .friend-request-actions {
            display: flex;
            gap: 5px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .accept-btn-small {
            background: #4caf50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .reject-btn-small {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-friend-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (min-width: 768px) {
            .chat-header {
                padding: 20px;
            }
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            flex: 1;
            min-width: 0;
        }

        .chat-user-info:hover {
            opacity: 0.8;
        }

        .chat-user-info .user-details {
            min-width: 0;
            flex: 1;
        }

        .chat-user-info h3 {
            font-size: 16px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-user-info p {
            font-size: 12px;
            color: #666;
        }

        .typing-indicator {
            font-size: 11px;
            color: #667eea;
            font-style: italic;
            margin-top: 2px;
        }

        .call-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .call-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .call-btn {
                padding: 10px 20px;
            }
        }

        .video-call-btn {
            background: #4caf50;
            color: white;
        }

        .audio-call-btn {
            background: #2196f3;
            color: white;
        }

        .call-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .call-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f9f9f9;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 768px) {
            .chat-messages {
                padding: 20px;
            }
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            position: relative;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 85%;
            padding: 10px 12px;
            border-radius: 18px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            word-wrap: break-word;
            position: relative;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .message-content {
                max-width: 60%;
                padding: 10px 15px;
                font-size: 16px;
            }
        }

        .message.sent .message-content {
            background: #667eea;
            color: white;
        }

        .message.deleted .message-content {
            background: #e0e0e0;
            color: #999;
            font-style: italic;
        }

        .message.sent.deleted .message-content {
            background: #b39ddb;
        }

        .message-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        @media (min-width: 768px) {
            .message-image {
                max-width: 200px;
                max-height: 200px;
            }
        }

        .message-image:hover {
            transform: scale(1.05);
        }

        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        @media (min-width: 768px) {
            .message-time {
                font-size: 11px;
            }
        }

        .message-status {
            font-size: 10px;
            margin-left: 5px;
        }

        .message-actions {
            position: absolute;
            top: -10px;
            right: -10px;
            display: none;
            gap: 5px;
            background: white;
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .message.sent .message-actions {
            right: auto;
            left: -10px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: none;
            background: #f0f0f0;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .message-action-btn:hover {
            background: #ff4444;
            color: white;
        }

        .chat-input {
            padding: 12px 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        @media (min-width: 768px) {
            .chat-input {
                padding: 20px;
                gap: 10px;
            }
        }

        .chat-input input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .chat-input input {
                padding: 12px;
                font-size: 16px;
            }
        }

        .chat-input input:focus {
            border-color: #667eea;
        }

        .chat-input button {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            background: #667eea;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .chat-input button {
                padding: 12px 25px;
            }
        }

        .chat-input button:hover {
            background: #5a67d8;
        }

        .chat-input button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .image-upload-btn {
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 12px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .image-upload-btn {
                padding: 12px 20px;
            }
        }

        .image-upload-btn:hover {
            background: #2d3748;
        }

        /* Profile Modal */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .profile-content {
            background: white;
            border-radius: 20px;
            padding: 25px 20px;
            max-width: 400px;
            width: 100%;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .profile-avatar {
                width: 80px;
                height: 80px;
                font-size: 32px;
            }
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-info h2 {
            font-size: 18px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 768px) {
            .profile-info h2 {
                font-size: 20px;
            }
        }

        .profile-info p {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-field {
            margin-bottom: 15px;
        }

        .profile-field label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .profile-field input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            outline: none;
            font-size: 14px;
        }

        .profile-field input:focus {
            border-color: #667eea;
        }

        .profile-field p {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
            font-size: 14px;
            word-break: break-word;
        }

        .profile-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-close:hover {
            color: #333;
        }

        .profile-save-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            font-size: 16px;
        }

        .profile-save-btn:hover {
            background: #5a67d8;
        }

        /* Video Call Modal */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
        }

        .video-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .video-grid {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 10px;
        }

        @media (min-width: 768px) {
            .video-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 20px;
            }
        }

        .video-wrapper {
            position: relative;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            height: 45vh;
        }

        @media (min-width: 768px) {
            .video-wrapper {
                height: auto;
            }
        }

        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        .call-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        @media (min-width: 768px) {
            .call-controls {
                bottom: 30px;
                gap: 20px;
                padding: 15px 30px;
            }
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .control-btn.end-call {
            background: #f44336;
        }

        .control-btn.end-call:hover {
            background: #d32f2f;
        }

        .incoming-call-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px 20px;
            border-radius: 20px;
            text-align: center;
            z-index: 2001;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 350px;
        }

        .incoming-call-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .accept-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: #4caf50;
            color: white;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            font-size: 16px;
        }

        .reject-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: #f44336;
            color: white;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            font-size: 16px;
        }

        .notification {
            position: fixed;
            top: 10px;
            right: 10px;
            left: 10px;
            padding: 12px 20px;
            background: #333;
            color: white;
            border-radius: 10px;
            animation: slideIn 0.3s;
            z-index: 3000;
            font-size: 14px;
            text-align: center;
        }

        @media (min-width: 768px) {
            .notification {
                top: 20px;
                right: 20px;
                left: auto;
                min-width: 300px;
            }
        }

        /* Image Preview Modal */
        .image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2500;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .image-preview-content {
            max-width: 100%;
            max-height: 80vh;
        }

        .image-preview-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .image-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-confirm-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px 20px;
            border-radius: 20px;
            text-align: center;
            z-index: 2600;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 350px;
        }

        .delete-confirm-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .confirm-delete-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: #f44336;
            color: white;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            font-size: 16px;
        }

        .cancel-delete-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: #ccc;
            color: #333;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            font-size: 16px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .unread-indicator {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: #f44336;
            color: white;
            border-radius: 50%;
            min-width: 22px;
            height: 22px;
            padding: 0 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login/Register Section -->
        <div class="auth-section" id="authSection">
            <h1>ü§ù ConnectChat</h1>
            <p>Connect with friends through friend requests, chat, and video calls</p>
            
            <div class="auth-form">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
                </div>
                
                <div id="loginForm">
                    <div class="input-group">
                        <input type="email" id="loginEmail" placeholder="Email" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="loginPassword" placeholder="Password" required>
                    </div>
                    <button class="auth-btn" onclick="loginWithEmail()">Login</button>
                </div>
                
                <div id="registerForm" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="regName" placeholder="Full Name" required>
                    </div>
                    <div class="input-group">
                        <input type="email" id="regEmail" placeholder="Email" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="regPassword" placeholder="Password" required>
                    </div>
                    <button class="auth-btn" onclick="registerWithEmail()">Register</button>
                </div>
            </div>
        </div>

        <!-- Main App Section -->
        <div class="app-section" id="appSection">
            <div class="app-container">
                <!-- Mobile Header -->
                <div class="mobile-header">
                    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                    <div class="mobile-title" id="mobileChatTitle">ConnectChat</div>
                    <div style="width: 30px;"></div>
                </div>

                <!-- Sidebar Overlay -->
                <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

                <!-- Mobile Sidebar -->
                <div class="mobile-sidebar" id="mobileSidebar">
                    <div class="sidebar">
                        <div class="user-profile" onclick="showProfileModal()">
                            <div class="avatar" id="userAvatar">ML</div>
                            <div class="user-info">
                                <h3 id="userName">Mr. Lama</h3>
                                <div class="status-toggle">
                                    <input type="checkbox" id="onlineStatus" checked onchange="toggleOnlineStatus()">
                                    <label for="onlineStatus">Online</label>
                                </div>
                            </div>
                            <button class="logout-btn" onclick="logout(event)">üö™</button>
                        </div>
                        
                        <div class="tabs">
                            <div class="tab active" onclick="switchTab('friends')" id="friendsTab">Friends</div>
                            <div class="tab" onclick="switchTab('requests')" id="requestsTab">
                                Requests <span class="friend-request-badge" id="requestBadge" style="display: none;">0</span>
                            </div>
                            <div class="tab" onclick="switchTab('search')" id="searchTab">Search</div>
                        </div>
                        
                        <div class="tab-content" id="tabContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Main Chat Area -->
                <div class="main-content">
                    <div class="chat-header">
                        <div class="chat-user-info" onclick="showFriendProfile()">
                            <div class="avatar" id="chatUserAvatar">?</div>
                            <div class="user-details">
                                <h3 id="chatUserName">Select a friend</h3>
                                <p id="chatUserStatus">...</p>
                                <div class="typing-indicator" id="typingIndicator" style="display: none;">typing...</div>
                            </div>
                        </div>
                        <div class="call-buttons">
                            <button class="call-btn video-call-btn" onclick="startVideoCall()" id="videoCallBtn" disabled>üìπ</button>
                            <button class="call-btn audio-call-btn" onclick="startAudioCall()" id="audioCallBtn" disabled>üé§</button>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will appear here -->
                    </div>

                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)" oninput="handleTyping()" disabled>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="sendImage()">
                        <button class="image-upload-btn" onclick="document.getElementById('imageInput').click()" id="imageUploadBtn" disabled>üì∑</button>
                        <button onclick="sendMessage()" id="sendBtn" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <button class="profile-close" onclick="hideProfileModal()">&times;</button>
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">ML</div>
                <div class="profile-info">
                    <h2 id="profileName">Mr. Lama</h2>
                    <p id="profileEmail">lamaproject2026@gmail.com</p>
                </div>
            </div>
            <div class="profile-field">
                <label>Display Name</label>
                <input type="text" id="profileDisplayName" placeholder="Enter your name" value="Mr. Lama">
            </div>
            <div class="profile-field">
                <label>Bio</label>
                <input type="text" id="profileBio" placeholder="Tell something about yourself">
            </div>
            <div class="profile-field">
                <label>Status</label>
                <input type="text" id="profileStatus" placeholder="e.g., Coding, Gaming, etc.">
            </div>
            <button class="profile-save-btn" onclick="saveProfile()">Save Changes</button>
        </div>
    </div>

    <!-- Friend Profile Modal -->
    <div class="profile-modal" id="friendProfileModal">
        <div class="profile-content">
            <button class="profile-close" onclick="hideFriendProfileModal()">&times;</button>
            <div class="profile-header">
                <div class="profile-avatar" id="friendProfileAvatar">JD</div>
                <div class="profile-info">
                    <h2 id="friendProfileName">Friend Name</h2>
                    <p id="friendProfileEmail">friend@example.com</p>
                </div>
            </div>
            <div class="profile-field">
                <label>Bio</label>
                <p id="friendProfileBio">No bio available</p>
            </div>
            <div class="profile-field">
                <label>Status</label>
                <p id="friendProfileStatus">No status available</p>
            </div>
            <div class="profile-field">
                <label>Last Seen</label>
                <p id="friendProfileLastSeen">Unknown</p>
            </div>
        </div>
    </div>

    <!-- Video Call Modal -->
    <div class="video-modal" id="videoModal">
        <div class="video-container">
            <div class="video-grid" id="videoGrid">
                <div class="video-wrapper" id="localVideoWrapper">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="video-label">You</div>
                </div>
                <div class="video-wrapper" id="remoteVideoWrapper">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="video-label" id="remoteVideoLabel">Remote User</div>
                </div>
            </div>
            <div class="call-controls">
                <button class="control-btn" onclick="toggleMute()" id="muteBtn">üé§</button>
                <button class="control-btn" onclick="toggleVideo()" id="videoBtn">üìπ</button>
                <button class="control-btn end-call" onclick="endCall()">üìû</button>
            </div>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div class="incoming-call-modal" id="incomingCallModal">
        <h2 id="incomingCaller">Incoming Call...</h2>
        <p id="callType">Video Call</p>
        <div class="incoming-call-buttons">
            <button class="accept-btn" onclick="acceptCall()">Accept</button>
            <button class="reject-btn" onclick="rejectCall()">Reject</button>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="image-preview-modal" id="imagePreviewModal" onclick="hideImagePreview()">
        <div class="image-preview-content">
            <img id="previewImage" src="" alt="Preview">
        </div>
        <div class="image-preview-close" onclick="hideImagePreview()">&times;</div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="delete-confirm-modal" id="deleteConfirmModal">
        <h3>Delete Message?</h3>
        <p>This action cannot be undone.</p>
        <div class="delete-confirm-buttons">
            <button class="confirm-delete-btn" onclick="confirmDeleteMessage()">Delete</button>
            <button class="cancel-delete-btn" onclick="cancelDeleteMessage()">Cancel</button>
        </div>
    </div>

    <!-- Audio Elements with actual working sounds -->
    <audio id="messageSound" preload="auto" style="display: none;">
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" type="audio/mpeg">
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.ogg" type="audio/ogg">
    </audio>
    
    <audio id="callSound" preload="auto" loop style="display: none;">
        <source src="https://www.soundjay.com/phone/sounds/phone-ringing-01.mp3" type="audio/mpeg">
        <source src="https://www.soundjay.com/phone/sounds/phone-ringing-01.ogg" type="audio/ogg">
    </audio>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtPQ_HcTZtqlPuQ11awTUOIiPjvpMNWlU",
            authDomain: "khaji-23a99.firebaseapp.com",
            databaseURL: "https://khaji-23a99-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "khaji-23a99",
            storageBucket: "khaji-23a99.firebasestorage.app",
            messagingSenderId: "84794766200",
            appId: "1:84794766200:web:207a50412961d45275ce8d",
            measurementId: "G-2RE1L7HQTZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let selectedUser = null;
        let currentChatId = null;
        let currentTab = 'friends';
        let typingTimeout = null;
        let messageToDelete = null;
        let unreadMessages = new Map();
        
        // WebRTC variables
        let localStream = null;
        let peerConnection = null;
        let isCallActive = false;
        let callType = null;
        let incomingCall = null;
        let callDocId = null;
        let callSound = document.getElementById('callSound');
        let messageSound = document.getElementById('messageSound');
        
        // Configuration for WebRTC with multiple STUN/TURN servers for better connectivity
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                { urls: 'stun:stun.ekiga.net' },
                { urls: 'stun:stun.ideasip.com' },
                { urls: 'stun:stun.schlund.de' },
                { urls: 'stun:stun.stunprotocol.org:3478' },
                { urls: 'stun:stun.voiparound.com' },
                { urls: 'stun:stun.voipbuster.com' }
            ]
        };

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                currentUser = {
                    uid: user.uid,
                    name: user.displayName || "Mr. Lama",
                    email: user.email,
                    online: document.getElementById('onlineStatus').checked
                };
                
                // Save user to database
                await database.ref('users/' + user.uid).set({
                    name: currentUser.name,
                    email: currentUser.email,
                    online: currentUser.online,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    bio: user.bio || '',
                    status: user.status || ''
                });
                
                // Set user as offline when disconnected
                database.ref('users/' + user.uid + '/online').onDisconnect().set(false);
                database.ref('users/' + user.uid + '/lastSeen').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                
                showApp();
                loadFriends();
                listenForFriendRequests();
                listenForCalls();
                
                // Load user profile data
                loadUserProfile();
                
                // Preload audio
                messageSound.load();
                callSound.load();
            } else {
                showAuth();
            }
        });

        // Toggle mobile sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('mobileSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        // Load user profile data
        async function loadUserProfile() {
            if (!currentUser) return;
            
            const snapshot = await database.ref('users/' + currentUser.uid).once('value');
            const userData = snapshot.val();
            
            if (userData) {
                document.getElementById('profileDisplayName').value = userData.name || 'Mr. Lama';
                document.getElementById('profileBio').value = userData.bio || '';
                document.getElementById('profileStatus').value = userData.status || '';
            }
        }

        // Show profile modal
        function showProfileModal() {
            document.getElementById('profileModal').style.display = 'flex';
        }

        // Hide profile modal
        function hideProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        // Save profile
        async function saveProfile() {
            const name = document.getElementById('profileDisplayName').value;
            const bio = document.getElementById('profileBio').value;
            const status = document.getElementById('profileStatus').value;
            
            try {
                // Update Firebase
                await database.ref('users/' + currentUser.uid).update({
                    name: name,
                    bio: bio,
                    status: status
                });
                
                // Update local user
                currentUser.name = name;
                
                // Update UI
                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = getInitials(name);
                document.getElementById('profileName').textContent = name;
                document.getElementById('profileAvatar').textContent = getInitials(name);
                
                // Update Firebase Auth display name
                await auth.currentUser.updateProfile({
                    displayName: name
                });
                
                hideProfileModal();
                showNotification('Profile updated successfully!', 'success');
                
                // Refresh friends list to show updated name
                loadFriends();
            } catch (error) {
                showNotification('Error updating profile: ' + error.message, 'error');
            }
        }

        // Show friend profile
        async function showFriendProfile() {
            if (!selectedUser) return;
            
            // Refresh friend data
            const snapshot = await database.ref('users/' + selectedUser.uid).once('value');
            selectedUser = {
                uid: selectedUser.uid,
                ...snapshot.val()
            };
            
            document.getElementById('friendProfileName').textContent = selectedUser.name;
            document.getElementById('friendProfileEmail').textContent = selectedUser.email;
            document.getElementById('friendProfileAvatar').textContent = getInitials(selectedUser.name);
            document.getElementById('friendProfileBio').textContent = selectedUser.bio || 'No bio available';
            document.getElementById('friendProfileStatus').textContent = selectedUser.status || 'No status available';
            
            const lastSeen = selectedUser.lastSeen ? new Date(selectedUser.lastSeen).toLocaleString() : 'Unknown';
            document.getElementById('friendProfileLastSeen').textContent = lastSeen;
            
            document.getElementById('friendProfileModal').style.display = 'flex';
        }

        // Hide friend profile modal
        function hideFriendProfileModal() {
            document.getElementById('friendProfileModal').style.display = 'none';
        }

        // Toggle online status
        async function toggleOnlineStatus() {
            const isOnline = document.getElementById('onlineStatus').checked;
            
            if (currentUser) {
                await database.ref('users/' + currentUser.uid).update({
                    online: isOnline,
                    lastSeen: isOnline ? null : firebase.database.ServerValue.TIMESTAMP
                });
                
                currentUser.online = isOnline;
            }
        }

        // Switch between login and register tabs
        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
            } else {
                tabs[1].classList.add('active');
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
            }
        }

        // Email/Password Login
        async function loginWithEmail() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Login successful!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Email/Password Register
        async function registerWithEmail() {
            const name = document.getElementById('regName').value || "Mr. Lama";
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({
                    displayName: name
                });
                showNotification('Registration successful!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Logout
        async function logout(event) {
            event.stopPropagation();
            
            if (currentUser) {
                await database.ref('users/' + currentUser.uid).update({
                    online: false,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            }
            await auth.signOut();
        }

        // Show main app
        function showApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            
            // Update user profile
            if (currentUser) {
                document.getElementById('userAvatar').textContent = getInitials(currentUser.name);
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('profileName').textContent = currentUser.name;
                document.getElementById('profileEmail').textContent = currentUser.email;
                document.getElementById('profileAvatar').textContent = getInitials(currentUser.name);
            }
        }

        // Show auth section
        function showAuth() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('appSection').style.display = 'none';
            currentUser = null;
            selectedUser = null;
        }

        // Get initials from name
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        // Switch between tabs
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab styles
            document.getElementById('friendsTab').classList.remove('active');
            document.getElementById('requestsTab').classList.remove('active');
            document.getElementById('searchTab').classList.remove('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // Load tab content
            if (tab === 'friends') {
                loadFriends();
            } else if (tab === 'requests') {
                loadFriendRequests();
            } else if (tab === 'search') {
                loadSearchUsers();
            }
            
            // Close sidebar on mobile after tab switch
            if (window.innerWidth < 768) {
                toggleSidebar();
            }
        }

        // Load friends list
        function loadFriends() {
            database.ref('friendships').orderByChild(currentUser.uid + '/status').equalTo('accepted').on('value', (snapshot) => {
                const friendships = snapshot.val();
                const friendIds = [];
                
                if (friendships) {
                    Object.keys(friendships).forEach(key => {
                        const friendship = friendships[key];
                        if (friendship[currentUser.uid] && friendship[currentUser.uid].status === 'accepted') {
                            const otherId = Object.keys(friendship).find(id => id !== currentUser.uid);
                            if (otherId) friendIds.push(otherId);
                        }
                    });
                }
                
                loadUsersByIds(friendIds, 'friends');
            });
        }

        // Load friend requests
        function loadFriendRequests() {
            database.ref('friendRequests').orderByChild('to').equalTo(currentUser.uid).on('value', (snapshot) => {
                const requests = snapshot.val();
                const requestIds = [];
                const requestData = {};
                
                if (requests) {
                    Object.keys(requests).forEach(key => {
                        const request = requests[key];
                        if (request.status === 'pending') {
                            requestIds.push(request.from);
                            requestData[request.from] = key;
                        }
                    });
                }
                
                // Update badge
                const badge = document.getElementById('requestBadge');
                if (requestIds.length > 0) {
                    badge.style.display = 'inline';
                    badge.textContent = requestIds.length;
                } else {
                    badge.style.display = 'none';
                }
                
                loadUsersByIds(requestIds, 'requests', requestData);
            });
        }

        // Load search users (all users except self and friends)
        function loadSearchUsers() {
            database.ref('users').once('value', (snapshot) => {
                const users = snapshot.val();
                const allUsers = [];
                
                // First, get friends
                database.ref('friendships').orderByChild(currentUser.uid + '/status').equalTo('accepted').once('value', (friendsSnapshot) => {
                    const friendships = friendsSnapshot.val();
                    const friendIds = [];
                    
                    if (friendships) {
                        Object.keys(friendships).forEach(key => {
                            const friendship = friendships[key];
                            if (friendship[currentUser.uid] && friendship[currentUser.uid].status === 'accepted') {
                                const otherId = Object.keys(friendship).find(id => id !== currentUser.uid);
                                if (otherId) friendIds.push(otherId);
                            }
                        });
                    }
                    
                    // Get pending requests
                    database.ref('friendRequests').orderByChild('from').equalTo(currentUser.uid).once('value', (sentSnapshot) => {
                        const sentRequests = sentSnapshot.val();
                        const pendingIds = [];
                        
                        if (sentRequests) {
                            Object.keys(sentRequests).forEach(key => {
                                if (sentRequests[key].status === 'pending') {
                                    pendingIds.push(sentRequests[key].to);
                                }
                            });
                        }
                        
                        // Filter users
                        Object.keys(users).forEach(uid => {
                            if (uid !== currentUser.uid && 
                                !friendIds.includes(uid) && 
                                !pendingIds.includes(uid)) {
                                allUsers.push({
                                    uid: uid,
                                    ...users[uid]
                                });
                            }
                        });
                        
                        displayUsers(allUsers, 'search');
                    });
                });
            });
        }

        // Load users by IDs
        function loadUsersByIds(userIds, type, requestData = {}) {
            if (userIds.length === 0) {
                displayUsers([], type);
                return;
            }
            
            const users = [];
            let loaded = 0;
            
            userIds.forEach(uid => {
                database.ref('users/' + uid).once('value', (snapshot) => {
                    const user = snapshot.val();
                    if (user) {
                        users.push({
                            uid: uid,
                            ...user,
                            requestKey: requestData[uid]
                        });
                    }
                    
                    loaded++;
                    if (loaded === userIds.length) {
                        displayUsers(users, type);
                    }
                });
            });
        }

        // Display users in tab content
        function displayUsers(users, type) {
            const tabContent = document.getElementById('tabContent');
            
            if (users.length === 0) {
                if (type === 'friends') {
                    tabContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No friends yet. Add some friends!</div>';
                } else if (type === 'requests') {
                    tabContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No pending friend requests</div>';
                } else {
                    tabContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No users found</div>';
                }
                return;
            }
            
            let html = '';
            users.forEach(user => {
                const isOnline = user.online ? '' : 'offline';
                const lastSeen = user.lastSeen ? new Date(user.lastSeen).toLocaleString() : 'Unknown';
                const statusText = user.status ? ` - ${user.status}` : '';
                const unreadCount = unreadMessages.get(user.uid) || 0;
                const unreadClass = unreadCount > 0 ? 'unread' : '';
                
                if (type === 'friends') {
                    html += `
                        <div class="user-item ${unreadClass}" onclick="selectUser('${user.uid}')">
                            <div class="avatar">${getInitials(user.name)}</div>
                            <div class="user-info">
                                <h4>${user.name}</h4>
                                <p style="font-size: 12px; color: #666;">${user.email}${statusText}</p>
                            </div>
                            <div class="user-status ${isOnline}" title="Last seen: ${lastSeen}"></div>
                            ${unreadCount > 0 ? `<span class="message-count">${unreadCount}</span>` : ''}
                        </div>
                    `;
                } else if (type === 'requests') {
                    html += `
                        <div class="user-item">
                            <div class="avatar">${getInitials(user.name)}</div>
                            <div class="user-info">
                                <h4>${user.name}</h4>
                                <p style="font-size: 12px; color: #666;">${user.email}</p>
                            </div>
                            <div class="friend-request-actions">
                                <button class="accept-btn-small" onclick="acceptFriendRequest('${user.uid}', '${user.requestKey}')">‚úì Accept</button>
                                <button class="reject-btn-small" onclick="rejectFriendRequest('${user.uid}', '${user.requestKey}')">‚úó Reject</button>
                            </div>
                        </div>
                    `;
                } else if (type === 'search') {
                    html += `
                        <div class="user-item">
                            <div class="avatar">${getInitials(user.name)}</div>
                            <div class="user-info">
                                <h4>${user.name}</h4>
                                <p style="font-size: 12px; color: #666;">${user.email}</p>
                            </div>
                            <button class="add-friend-btn" onclick="sendFriendRequest('${user.uid}')">+ Add Friend</button>
                        </div>
                    `;
                }
            });
            
            tabContent.innerHTML = html;
        }

        // Send friend request
        async function sendFriendRequest(toUid) {
            try {
                const requestRef = database.ref('friendRequests').push();
                await requestRef.set({
                    from: currentUser.uid,
                    to: toUid,
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                showNotification('Friend request sent!', 'success');
                loadSearchUsers(); // Refresh search
            } catch (error) {
                showNotification('Error sending friend request', 'error');
            }
        }

        // Accept friend request
        async function acceptFriendRequest(fromUid, requestKey) {
            try {
                // Update request status
                await database.ref('friendRequests/' + requestKey).update({
                    status: 'accepted'
                });
                
                // Create friendship
                const friendshipId = [currentUser.uid, fromUid].sort().join('_');
                await database.ref('friendships/' + friendshipId).set({
                    [currentUser.uid]: {
                        status: 'accepted',
                        since: firebase.database.ServerValue.TIMESTAMP
                    },
                    [fromUid]: {
                        status: 'accepted',
                        since: firebase.database.ServerValue.TIMESTAMP
                    }
                });
                
                showNotification('Friend request accepted!', 'success');
                loadFriendRequests(); // Refresh requests
            } catch (error) {
                showNotification('Error accepting friend request', 'error');
            }
        }

        // Reject friend request
        async function rejectFriendRequest(fromUid, requestKey) {
            try {
                await database.ref('friendRequests/' + requestKey).remove();
                showNotification('Friend request rejected', 'info');
                loadFriendRequests(); // Refresh requests
            } catch (error) {
                showNotification('Error rejecting friend request', 'error');
            }
        }

        // Listen for friend requests
        function listenForFriendRequests() {
            database.ref('friendRequests').orderByChild('to').equalTo(currentUser.uid).on('value', (snapshot) => {
                const requests = snapshot.val();
                let count = 0;
                
                if (requests) {
                    Object.keys(requests).forEach(key => {
                        if (requests[key].status === 'pending') {
                            count++;
                        }
                    });
                }
                
                // Update badge
                const badge = document.getElementById('requestBadge');
                if (count > 0) {
                    badge.style.display = 'inline';
                    badge.textContent = count;
                } else {
                    badge.style.display = 'none';
                }
            });
        }

        // Select user to chat with
        function selectUser(uid) {
            database.ref('users/' + uid).once('value', (snapshot) => {
                selectedUser = {
                    uid: uid,
                    ...snapshot.val()
                };
                
                // Clear unread messages for this user
                unreadMessages.delete(uid);
                loadFriends(); // Refresh friends list to update unread indicators
                
                // Create or get chat room
                const chatId = [currentUser.uid, uid].sort().join('_');
                currentChatId = chatId;
                
                // Create chat room if it doesn't exist
                database.ref('chats/' + chatId).set({
                    participants: {
                        [currentUser.uid]: true,
                        [uid]: true
                    },
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Update UI
                document.getElementById('chatUserAvatar').textContent = getInitials(selectedUser.name);
                document.getElementById('chatUserName').textContent = selectedUser.name;
                document.getElementById('chatUserStatus').textContent = selectedUser.online ? 'Online' : 'Offline';
                document.getElementById('mobileChatTitle').textContent = selectedUser.name;
                
                // Enable chat controls
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('videoCallBtn').disabled = false;
                document.getElementById('audioCallBtn').disabled = false;
                document.getElementById('imageUploadBtn').disabled = false;
                
                // Load messages
                loadMessages();
                
                // Listen for typing indicator
                listenForTyping();
                
                // Close sidebar on mobile after selecting user
                if (window.innerWidth < 768) {
                    toggleSidebar();
                }
            });
        }

        // Listen for typing indicator
        function listenForTyping() {
            if (!currentChatId) return;
            
            const typingRef = database.ref('typing/' + currentChatId);
            typingRef.off();
            typingRef.on('value', (snapshot) => {
                const typingData = snapshot.val();
                const typingIndicator = document.getElementById('typingIndicator');
                
                if (typingData && typingData[selectedUser.uid]) {
                    typingIndicator.style.display = 'block';
                } else {
                    typingIndicator.style.display = 'none';
                }
            });
        }

        // Handle typing
        function handleTyping() {
            if (!currentChatId || !selectedUser) return;
            
            const typingRef = database.ref('typing/' + currentChatId + '/' + currentUser.uid);
            typingRef.set(true);
            
            // Clear previous timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // Set timeout to stop typing indicator
            typingTimeout = setTimeout(() => {
                typingRef.remove();
            }, 2000);
        }

        // Load messages
        function loadMessages() {
            if (!currentChatId) return;
            
            const messagesRef = database.ref('messages/' + currentChatId).orderByChild('timestamp');
            
            messagesRef.off(); // Remove previous listener
            messagesRef.on('child_added', (snapshot) => {
                const msg = snapshot.val();
                
                // Play sound for new message if not from current user
                if (msg.sender !== currentUser.uid && (!selectedUser || selectedUser.uid !== msg.sender)) {
                    playMessageSound();
                    
                    // Update unread count
                    const count = unreadMessages.get(msg.sender) || 0;
                    unreadMessages.set(msg.sender, count + 1);
                    loadFriends(); // Refresh friends list to show unread indicators
                }
            });
            
            messagesRef.on('value', (snapshot) => {
                const messages = snapshot.val();
                const chatMessages = document.getElementById('chatMessages');
                
                if (!messages) {
                    chatMessages.innerHTML = '<div style="text-align: center; color: #999; margin-top: 50px;">No messages yet. Start a conversation!</div>';
                    return;
                }
                
                let html = '';
                const messageKeys = Object.keys(messages).sort((a, b) => messages[a].timestamp - messages[b].timestamp);
                
                messageKeys.forEach(key => {
                    const msg = messages[key];
                    const isSent = msg.sender === currentUser.uid;
                    const isDeleted = msg.deleted === true;
                    const messageClass = isDeleted ? 'deleted' : '';
                    
                    // Mark messages as seen if they're from the selected user and we're viewing them
                    if (!isSent && selectedUser && msg.sender === selectedUser.uid && msg.status !== 'seen') {
                        database.ref('messages/' + currentChatId + '/' + key).update({
                            status: 'seen',
                            seenAt: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                    
                    if (msg.type === 'image' && !isDeleted) {
                        html += `
                            <div class="message ${isSent ? 'sent' : ''} ${messageClass}" data-message-id="${key}">
                                <div class="message-content">
                                    <img src="${msg.imageUrl}" class="message-image" onclick="showImagePreview('${msg.imageUrl}')" alt="Image">
                                    <div class="message-time">
                                        ${formatTime(msg.timestamp)}
                                        ${isSent ? `<span class="message-status">${getMessageStatus(msg.status)}</span>` : ''}
                                    </div>
                                    ${isSent ? getMessageActions(key) : ''}
                                </div>
                            </div>
                        `;
                    } else if (!isDeleted) {
                        html += `
                            <div class="message ${isSent ? 'sent' : ''} ${messageClass}" data-message-id="${key}">
                                <div class="message-content">
                                    ${msg.text}
                                    <div class="message-time">
                                        ${formatTime(msg.timestamp)}
                                        ${isSent ? `<span class="message-status">${getMessageStatus(msg.status)}</span>` : ''}
                                    </div>
                                    ${isSent ? getMessageActions(key) : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="message ${isSent ? 'sent' : ''} ${messageClass}" data-message-id="${key}">
                                <div class="message-content">
                                    This message was deleted
                                    <div class="message-time">
                                        ${formatTime(msg.timestamp)}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                chatMessages.innerHTML = html;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        // Play message sound
        function playMessageSound() {
            try {
                messageSound.currentTime = 0;
                messageSound.play().catch(e => console.log('Audio play failed:', e));
            } catch (e) {
                console.log('Audio error:', e);
            }
        }

        // Play call sound
        function playCallSound() {
            try {
                callSound.loop = true;
                callSound.play().catch(e => console.log('Audio play failed:', e));
            } catch (e) {
                console.log('Audio error:', e);
            }
        }

        // Stop call sound
        function stopCallSound() {
            try {
                callSound.pause();
                callSound.currentTime = 0;
            } catch (e) {
                console.log('Audio error:', e);
            }
        }

        // Get message status emoji
        function getMessageStatus(status) {
            switch(status) {
                case 'seen':
                    return 'üëÅÔ∏è';
                case 'delivered':
                    return '‚úì‚úì';
                default:
                    return '‚úì';
            }
        }

        // Get message actions (delete button)
        function getMessageActions(messageId) {
            return `
                <div class="message-actions">
                    <button class="message-action-btn" onclick="deleteMessage('${messageId}', event)">üóëÔ∏è</button>
                </div>
            `;
        }

        // Delete message
        function deleteMessage(messageId, event) {
            event.stopPropagation();
            messageToDelete = messageId;
            document.getElementById('deleteConfirmModal').style.display = 'block';
        }

        // Confirm delete message
        async function confirmDeleteMessage() {
            if (!messageToDelete || !currentChatId) return;
            
            try {
                await database.ref('messages/' + currentChatId + '/' + messageToDelete).update({
                    deleted: true,
                    text: null,
                    imageUrl: null
                });
                
                showNotification('Message deleted', 'success');
            } catch (error) {
                showNotification('Error deleting message', 'error');
            }
            
            document.getElementById('deleteConfirmModal').style.display = 'none';
            messageToDelete = null;
        }

        // Cancel delete message
        function cancelDeleteMessage() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            messageToDelete = null;
        }

        // Format timestamp
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Send message
        async function sendMessage() {
            if (!selectedUser || !currentChatId) {
                showNotification('Please select a friend to chat with', 'warning');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Stop typing indicator
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                database.ref('typing/' + currentChatId + '/' + currentUser.uid).remove();
            }
            
            // Save message to Firebase
            const messageRef = database.ref('messages/' + currentChatId).push();
            await messageRef.set({
                sender: currentUser.uid,
                receiver: selectedUser.uid,
                text: text,
                type: 'text',
                status: 'sent',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Clear input
            input.value = '';
        }

        // Send image
        async function sendImage() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            if (!selectedUser || !currentChatId) {
                showNotification('Please select a friend to chat with', 'warning');
                return;
            }
            
            try {
                showNotification('Uploading image...', 'info');
                
                // Upload to Firebase Storage
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`chat_images/${currentChatId}/${Date.now()}_${file.name}`);
                await imageRef.put(file);
                
                // Get download URL
                const imageUrl = await imageRef.getDownloadURL();
                
                // Save message to Firebase
                const messageRef = database.ref('messages/' + currentChatId).push();
                await messageRef.set({
                    sender: currentUser.uid,
                    receiver: selectedUser.uid,
                    imageUrl: imageUrl,
                    type: 'image',
                    status: 'sent',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Clear input
                fileInput.value = '';
                
                showNotification('Image sent!', 'success');
            } catch (error) {
                console.error('Error sending image:', error);
                showNotification('Failed to send image: ' + error.message, 'error');
            }
        }

        // Show image preview
        function showImagePreview(imageUrl) {
            document.getElementById('previewImage').src = imageUrl;
            document.getElementById('imagePreviewModal').style.display = 'flex';
        }

        // Hide image preview
        function hideImagePreview() {
            document.getElementById('imagePreviewModal').style.display = 'none';
        }

        // Handle enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Video/Audio call functions
        async function startVideoCall() {
            if (!selectedUser) {
                showNotification('Please select a friend to call', 'warning');
                return;
            }
            
            if (!selectedUser.online) {
                showNotification('User is offline', 'warning');
                return;
            }
            
            callType = 'video';
            await initializeCall();
        }

        async function startAudioCall() {
            if (!selectedUser) {
                showNotification('Please select a friend to call', 'warning');
                return;
            }
            
            if (!selectedUser.online) {
                showNotification('User is offline', 'warning');
                return;
            }
            
            callType = 'audio';
            await initializeCall();
        }

        async function initializeCall() {
            try {
                showNotification('Initializing call...', 'info');
                
                // Get user media
                const constraints = {
                    video: callType === 'video',
                    audio: true
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('localVideo').srcObject = localStream;
                
                // Show video modal
                document.getElementById('videoModal').style.display = 'block';
                
                // Create call document in Firebase with unique ID
                callDocId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                await database.ref('calls/' + callDocId).set({
                    caller: currentUser.uid,
                    callee: selectedUser.uid,
                    type: callType,
                    status: 'ringing',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Create peer connection with better configuration
                peerConnection = new RTCPeerConnection(configuration);
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    console.log('‚úÖ Received remote track');
                    const remoteVideo = document.getElementById('remoteVideo');
                    if (remoteVideo.srcObject !== event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                        showNotification('Remote user connected!', 'success');
                    }
                };
                
                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('üì° Sending ICE candidate');
                        database.ref('calls/' + callDocId + '/iceCandidates/' + currentUser.uid).push(event.candidate);
                    }
                };
                
                // Log connection state changes
                peerConnection.onconnectionstatechange = () => {
                    console.log('üîå Connection state:', peerConnection.connectionState);
                    if (peerConnection.connectionState === 'connected') {
                        showNotification('Call connected!', 'success');
                    } else if (peerConnection.connectionState === 'disconnected' || 
                             peerConnection.connectionState === 'failed') {
                        showNotification('Call disconnected', 'error');
                        endCall();
                    }
                };
                
                // Handle ICE connection state
                peerConnection.oniceconnectionstatechange = () => {
                    console.log('‚ùÑÔ∏è ICE connection state:', peerConnection.iceConnectionState);
                };
                
                // Create offer with audio/video
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: callType === 'video'
                });
                await peerConnection.setLocalDescription(offer);
                
                // Save offer to Firebase
                await database.ref('calls/' + callDocId + '/offer').set({
                    type: offer.type,
                    sdp: offer.sdp
                });
                
                isCallActive = true;
                
                // Listen for answer
                database.ref('calls/' + callDocId + '/answer').on('value', (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && peerConnection && peerConnection.signalingState !== 'stable') {
                        console.log('üìû Received answer');
                        peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
                            .then(() => console.log('‚úÖ Remote description set'))
                            .catch(e => console.error('‚ùå Error setting remote description:', e));
                    }
                });
                
                // Listen for ICE candidates from callee
                database.ref('calls/' + callDocId + '/iceCandidates/' + selectedUser.uid).on('child_added', (snapshot) => {
                    const candidate = snapshot.val();
                    if (candidate && peerConnection) {
                        console.log('‚ûï Adding ICE candidate');
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                            .then(() => console.log('‚úÖ ICE candidate added'))
                            .catch(e => console.error('‚ùå Error adding ICE candidate:', e));
                    }
                });
                
                // Set timeout for call ringing
                setTimeout(() => {
                    if (isCallActive && peerConnection && peerConnection.connectionState !== 'connected') {
                        database.ref('calls/' + callDocId).once('value', (snapshot) => {
                            const call = snapshot.val();
                            if (call && call.status === 'ringing') {
                                showNotification('No answer', 'warning');
                                endCall();
                            }
                        });
                    }
                }, 30000); // 30 seconds timeout
                
            } catch (error) {
                console.error('‚ùå Error initializing call:', error);
                showNotification('Failed to initialize call: ' + error.message, 'error');
                endCall();
            }
        }

        // Listen for incoming calls
        function listenForCalls() {
            if (!currentUser) return;
            
            database.ref('calls').orderByChild('callee').equalTo(currentUser.uid).on('child_added', (snapshot) => {
                const call = snapshot.val();
                
                if (call.status === 'ringing' && call.callee === currentUser.uid && !isCallActive) {
                    // Get caller info
                    database.ref('users/' + call.caller).once('value', (userSnapshot) => {
                        const caller = userSnapshot.val();
                        
                        incomingCall = {
                            id: snapshot.key,
                            caller: call.caller,
                            callee: call.callee,
                            type: call.type,
                            callerInfo: caller
                        };
                        
                        document.getElementById('incomingCaller').textContent = `${caller.name} is calling...`;
                        document.getElementById('callType').textContent = call.type === 'video' ? 'üìπ Video Call' : 'üé§ Audio Call';
                        document.getElementById('incomingCallModal').style.display = 'block';
                        
                        // Play ringtone
                        playCallSound();
                    });
                }
            });
        }

        async function acceptCall() {
            if (!incomingCall) return;
            
            stopCallSound();
            document.getElementById('incomingCallModal').style.display = 'none';
            
            try {
                showNotification('Connecting...', 'info');
                
                // Update call status
                await database.ref('calls/' + incomingCall.id).update({
                    status: 'connected'
                });
                
                // Get user media
                const constraints = {
                    video: incomingCall.type === 'video',
                    audio: true
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('localVideo').srcObject = localStream;
                
                // Show video modal
                document.getElementById('videoModal').style.display = 'block';
                document.getElementById('remoteVideoLabel').textContent = incomingCall.callerInfo.name;
                
                // Create peer connection
                peerConnection = new RTCPeerConnection(configuration);
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    console.log('‚úÖ Received remote track');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                    showNotification('Call connected!', 'success');
                };
                
                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('üì° Sending ICE candidate');
                        database.ref('calls/' + incomingCall.id + '/iceCandidates/' + currentUser.uid).push(event.candidate);
                    }
                };
                
                // Log connection state changes
                peerConnection.onconnectionstatechange = () => {
                    console.log('üîå Connection state:', peerConnection.connectionState);
                };
                
                // Handle ICE connection state
                peerConnection.oniceconnectionstatechange = () => {
                    console.log('‚ùÑÔ∏è ICE connection state:', peerConnection.iceConnectionState);
                };
                
                // Get offer from Firebase
                const callSnapshot = await database.ref('calls/' + incomingCall.id).once('value');
                const call = callSnapshot.val();
                
                if (call.offer) {
                    console.log('üìû Setting remote description');
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(call.offer));
                    
                    // Create answer
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    // Save answer to Firebase
                    await database.ref('calls/' + incomingCall.id + '/answer').set({
                        type: answer.type,
                        sdp: answer.sdp
                    });
                }
                
                // Listen for ICE candidates from caller
                database.ref('calls/' + incomingCall.id + '/iceCandidates/' + incomingCall.caller).on('child_added', (snapshot) => {
                    const candidate = snapshot.val();
                    if (candidate && peerConnection) {
                        console.log('‚ûï Adding ICE candidate');
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                            .then(() => console.log('‚úÖ ICE candidate added'))
                            .catch(e => console.error('‚ùå Error adding ICE candidate:', e));
                    }
                });
                
                isCallActive = true;
                callDocId = incomingCall.id;
                
            } catch (error) {
                console.error('‚ùå Error accepting call:', error);
                showNotification('Failed to accept call: ' + error.message, 'error');
                endCall();
            }
        }

        function rejectCall() {
            if (incomingCall) {
                database.ref('calls/' + incomingCall.id).update({
                    status: 'rejected'
                });
            }
            stopCallSound();
            document.getElementById('incomingCallModal').style.display = 'none';
            incomingCall = null;
            showNotification('Call rejected');
        }

        function endCall() {
            // Close peer connection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Update call status in Firebase
            if (callDocId) {
                database.ref('calls/' + callDocId).update({
                    status: 'ended',
                    endedAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            // Hide video modal
            document.getElementById('videoModal').style.display = 'none';
            stopCallSound();
            
            isCallActive = false;
            callDocId = null;
            incomingCall = null;
            showNotification('Call ended');
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    document.getElementById('muteBtn').style.opacity = audioTrack.enabled ? '1' : '0.5';
                    document.getElementById('muteBtn').style.background = audioTrack.enabled ? 'rgba(255,255,255,0.2)' : '#f44336';
                }
            }
        }

        function toggleVideo() {
            if (localStream && callType === 'video') {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    document.getElementById('videoBtn').style.opacity = videoTrack.enabled ? '1' : '0.5';
                    document.getElementById('videoBtn').style.background = videoTrack.enabled ? 'rgba(255,255,255,0.2)' : '#f44336';
                }
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'error' ? '#f44336' : 
                                          type === 'success' ? '#4caf50' : 
                                          type === 'warning' ? '#ff9800' : '#333';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 768) {
                document.getElementById('mobileSidebar').classList.remove('open');
                document.getElementById('sidebarOverlay').classList.remove('open');
            }
        });
    </script>
</body>
</html>
