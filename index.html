<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Khaji Social Pro</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, setDoc, getDoc, getDocs, updateDoc, arrayUnion, arrayRemove, orderBy } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_MSG_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ================= GLOBAL STATE ================= */
let currentUser = null;
let currentUserData = null;
let currentChatId = null;
let peer = null;

/* ================= AUTH ================= */

registerBtn.onclick = async () => {
  const name = regName.value;
  const email = regEmail.value;
  const pass = regPass.value;
  if(!name || !email || !pass) return alert("Fill all fields");

  const cred = await createUserWithEmailAndPassword(auth, email, pass);

  await setDoc(doc(db,"users",cred.user.uid),{
    uid:cred.user.uid,
    name,
    email,
    photoURL:"",
    friends:[],
    requests:[],
    online:true
  });
};

loginBtn.onclick = async () => {
  await signInWithEmailAndPassword(auth, loginEmail.value, loginPass.value);
};

logoutBtn.onclick = async () => {
  await updateDoc(doc(db,"users",currentUser.uid),{online:false});
  await signOut(auth);
};

onAuthStateChanged(auth, async(user)=>{
  if(user){
    currentUser=user;
    loginView.classList.add("hidden");
    appView.classList.remove("hidden");
    await loadUser();
    loadPosts();
    loadFriends();
    initPeer(user.uid);
  } else {
    loginView.classList.remove("hidden");
    appView.classList.add("hidden");
  }
});

async function loadUser(){
  const snap = await getDoc(doc(db,"users",currentUser.uid));
  currentUserData = snap.data();
  userName.innerText=currentUserData.name;
  userPic.src=currentUserData.photoURL || `https://ui-avatars.com/api/?name=${currentUserData.name}`;
}

/* ================= POSTS ================= */

postBtn.onclick = async ()=>{
  const text=postInput.value.trim();
  const file=imageInput.files[0];
  if(!text && !file) return;

  let imageURL="";
  if(file){
    const imageRef=ref(storage,"posts/"+Date.now()+"_"+file.name);
    await uploadBytes(imageRef,file);
    imageURL=await getDownloadURL(imageRef);
  }

  await addDoc(collection(db,"posts"),{
    text,
    image:imageURL,
    uid:currentUser.uid,
    userName:currentUserData.name,
    userPhoto:currentUserData.photoURL||"",
    timestamp:serverTimestamp(),
    likes:[]
  });

  postInput.value="";
  imageInput.value="";
};

function loadPosts(){
  const q=query(collection(db,"posts"),orderBy("timestamp","desc"));
  onSnapshot(q,(snap)=>{
    postsContainer.innerHTML="";
    snap.forEach(d=>{
      const p=d.data();
      const liked=p.likes?.includes(currentUser.uid);
      postsContainer.innerHTML+=`
      <div class="bg-white p-4 rounded shadow mb-3">
        <div class="flex gap-2 items-center">
          <img src="${p.userPhoto||`https://ui-avatars.com/api/?name=${p.userName}`}" class="w-10 h-10 rounded-full">
          <h3 class="font-bold">${p.userName}</h3>
        </div>
        <p class="mt-2">${p.text||""}</p>
        ${p.image?`<img src="${p.image}" class="mt-2 rounded">`:""}
        <button onclick="toggleLike('${d.id}',${liked})" class="mt-2 text-sm ${liked?'text-blue-600 font-bold':''}">
          üëç ${p.likes?.length||0}
        </button>
      </div>`;
    });
  });
}

window.toggleLike=async(id,liked)=>{
  const refDoc=doc(db,"posts",id);
  if(liked){
    await updateDoc(refDoc,{likes:arrayRemove(currentUser.uid)});
  } else {
    await updateDoc(refDoc,{likes:arrayUnion(currentUser.uid)});
  }
};

/* ================= FRIENDS ================= */

searchInput.oninput=async()=>{
  const term=searchInput.value.toLowerCase();
  if(!term) return;
  const snap=await getDocs(collection(db,"users"));
  searchResults.innerHTML="";
  snap.forEach(d=>{
    const u=d.data();
    if(u.uid!==currentUser.uid && u.name.toLowerCase().includes(term)){
      searchResults.innerHTML+=`
      <div class="flex justify-between p-2">
        <span>${u.name}</span>
        <button onclick="sendReq('${u.uid}')">Add</button>
      </div>`;
    }
  });
};

window.sendReq=async(uid)=>{
  await updateDoc(doc(db,"users",uid),{
    requests:arrayUnion({uid:currentUser.uid,name:currentUserData.name})
  });
  alert("Request Sent");
};

function loadFriends(){
  onSnapshot(doc(db,"users",currentUser.uid),(snap)=>{
    currentUserData=snap.data();
    friendsContainer.innerHTML="";
    currentUserData.friends?.forEach(async(fid)=>{
      const fsnap=await getDoc(doc(db,"users",fid));
      const f=fsnap.data();
      friendsContainer.innerHTML+=`
      <div onclick="openChat('${f.uid}','${f.name}')" class="cursor-pointer">
        ${f.name}
      </div>`;
    });
  });
}

/* ================= CHAT ================= */

window.openChat=(fid,name)=>{
  currentChatId=[currentUser.uid,fid].sort().join("_");
  chatBox.classList.remove("hidden");
  chatTitle.innerText=name;

  const q=query(collection(db,"chats",currentChatId,"messages"),orderBy("timestamp"));
  onSnapshot(q,(snap)=>{
    chatMessages.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      chatMessages.innerHTML+=`
      <div class="${m.senderId===currentUser.uid?'text-right':''}">
        ${m.text}
      </div>`;
    });
  });
};

sendMsgBtn.onclick=async()=>{
  if(!chatInput.value) return;
  await addDoc(collection(db,"chats",currentChatId,"messages"),{
    text:chatInput.value,
    senderId:currentUser.uid,
    timestamp:serverTimestamp()
  });
  chatInput.value="";
};

/* ================= VIDEO CALL ================= */

function initPeer(uid){
  peer=new Peer(uid);
  peer.on("call",call=>{
    navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(stream=>{
      call.answer(stream);
      call.on("stream",remote=>{
        remoteVideo.srcObject=remote;
      });
      localVideo.srcObject=stream;
      videoModal.classList.remove("hidden");
    });
  });
}

videoBtn.onclick=()=>{
  const fid=chatTitle.innerText;
};

</script>
</head>

<body class="bg-gray-100">

<!-- SIMPLE UI (Minimal Clean Layout) -->

<div id="loginView">
<input id="loginEmail" placeholder="Email">
<input id="loginPass" placeholder="Password">
<button id="loginBtn">Login</button>
<hr>
<input id="regName" placeholder="Name">
<input id="regEmail" placeholder="Email">
<input id="regPass" placeholder="Password">
<button id="registerBtn">Register</button>
</div>

<div id="appView" class="hidden p-4">
<h1 class="text-2xl font-bold">Khaji Social</h1>
<button id="logoutBtn">Logout</button>

<div class="mt-4">
<input id="postInput" placeholder="What's on your mind?">
<input type="file" id="imageInput">
<button id="postBtn">Post</button>
</div>

<div id="postsContainer" class="mt-4"></div>

<div class="mt-4">
<input id="searchInput" placeholder="Search">
<div id="searchResults"></div>
</div>

<div id="friendsContainer" class="mt-4"></div>

<div id="chatBox" class="hidden fixed bottom-0 right-0 bg-white p-2 border">
<h3 id="chatTitle"></h3>
<div id="chatMessages"></div>
<input id="chatInput">
<button id="sendMsgBtn">Send</button>
</div>

<div id="videoModal" class="hidden fixed inset-0 bg-black">
<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>
</div>

</body>
</html>
