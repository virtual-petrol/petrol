<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ConnectChat Pro</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6fb}
.container{display:flex;height:100vh}
.sidebar{width:300px;background:#fff;border-right:1px solid #ddd;display:flex;flex-direction:column}
.main{flex:1;display:flex;flex-direction:column}
.header{padding:15px;background:#667eea;color:#fff}
.list{flex:1;overflow:auto}
.user{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.user:hover{background:#f0f0f0}
.chat{flex:1;overflow:auto;padding:15px;background:#f9f9f9}
.msg{margin:5px 0}
.sent{text-align:right}
.bubble{display:inline-block;padding:8px 12px;border-radius:15px;background:#fff;max-width:70%}
.sent .bubble{background:#667eea;color:#fff}
.input{display:flex;padding:10px;background:#fff}
input[type=text]{flex:1;padding:8px}
button{padding:6px 10px;margin:2px;cursor:pointer}
.typing{font-size:12px;color:#777;margin-left:10px}
.seen{font-size:10px;color:#aaa}
.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
background:#fff;padding:20px;border-radius:10px;display:none}
</style>
</head>
<body>

<div id="auth">
<h2>ConnectChat Login</h2>
<input id="email" placeholder="Email"><br><br>
<input id="pass" type="password" placeholder="Password"><br><br>
<button onclick="login()">Login</button>
<button onclick="register()">Register</button>
</div>

<div class="container" id="app" style="display:none">

<div class="sidebar">
<div class="header">
<b id="me"></b><br>
<small id="statusText">Online</small><br><br>
<button onclick="toggleStatus()">Toggle Status</button>
<button onclick="openProfile()">Profile</button>
<button onclick="logout()">Logout</button>
</div>
<div class="list" id="users"></div>
</div>

<div class="main">
<div class="header" id="chatTitle">Select User</div>
<div class="chat" id="chat"></div>
<div class="typing" id="typing"></div>
<div class="input">
<input type="text" id="msgBox" oninput="typingNow()" onkeypress="if(event.key==='Enter')send()">
<input type="file" id="imgFile" hidden onchange="sendImage()">
<button onclick="document.getElementById('imgFile').click()">ðŸ“·</button>
<button onclick="send()">Send</button>
</div>
</div>

</div>

<div class="modal" id="profileModal">
<h3>My Profile</h3>
<p>Name: <span id="pName"></span></p>
<p>Email: <span id="pEmail"></span></p>
<p>Status: <span id="pStatus"></span></p>
<button onclick="closeProfile()">Close</button>
</div>

<script>
/* ================= FIREBASE ================= */

const firebaseConfig = {
    apiKey: "AIzaSyBtPQ_HcTZtqlPuQ11awTUOIiPjvpMNWlU",
    authDomain: "khaji-23a99.firebaseapp.com",
    databaseURL: "https://khaji-23a99-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "khaji-23a99",
    storageBucket: "khaji-23a99.firebasestorage.app",
    messagingSenderId: "84794766200",
    appId: "1:84794766200:web:207a50412961d45275ce8d",
    measurementId: "G-2RE1L7HQTZ"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();
const storage=firebase.storage();

let me=null;
let currentChat=null;
let currentOther=null;

/* ================= AUTH ================= */

function login(){
auth.signInWithEmailAndPassword(email.value,pass.value);
}
function register(){
auth.createUserWithEmailAndPassword(email.value,pass.value);
}
function logout(){
if(me){
db.ref("users/"+me.uid+"/online").set(false);
}
auth.signOut();
}

/* ================= AUTH STATE ================= */

auth.onAuthStateChanged(u=>{
if(u){
me=u;
db.ref("users/"+u.uid).update({
email:u.email,
online:true,
lastSeen:Date.now()
});
db.ref("users/"+u.uid+"/online").onDisconnect().set(false);

auth.style="display:none";
document.getElementById("auth").style.display="none";
document.getElementById("app").style.display="flex";
document.getElementById("me").innerText=u.email;
loadUsers();
}else{
document.getElementById("auth").style.display="block";
document.getElementById("app").style.display="none";
}
});

/* ================= USERS ================= */

function loadUsers(){
db.ref("users").on("value",snap=>{
users.innerHTML="";
snap.forEach(s=>{
if(s.key!==me.uid){
let div=document.createElement("div");
div.className="user";
div.innerText=s.val().email+(s.val().online?" (Online)":" (Offline)");
div.onclick=()=>openChat(s.key,s.val().email);
users.appendChild(div);
}
});
});
}

/* ================= CHAT ================= */

function openChat(uid,email){
currentOther=uid;
currentChat=[me.uid,uid].sort().join("_");
chatTitle.innerText=email;
loadMessages();
listenTyping();
}

function send(){
let text=msgBox.value.trim();
if(!text||!currentChat)return;

db.ref("messages/"+currentChat).push({
sender:me.uid,
text:text,
time:Date.now(),
seen:false
});

msgBox.value="";
}

function sendImage(){
let file=imgFile.files[0];
if(!file)return;

let ref=storage.ref("chatImages/"+Date.now()+file.name);
ref.put(file).then(()=>{
ref.getDownloadURL().then(url=>{
db.ref("messages/"+currentChat).push({
sender:me.uid,
image:url,
time:Date.now(),
seen:false
});
});
});
}

function loadMessages(){
db.ref("messages/"+currentChat).on("value",snap=>{
chat.innerHTML="";
snap.forEach(s=>{
let m=s.val();
let div=document.createElement("div");
div.className="msg "+(m.sender===me.uid?"sent":"");

let bubble=document.createElement("div");
bubble.className="bubble";

if(m.text) bubble.innerText=m.text;
if(m.image){
let img=document.createElement("img");
img.src=m.image;
img.style.maxWidth="150px";
bubble.appendChild(img);
}

div.appendChild(bubble);

if(m.sender===me.uid){
let del=document.createElement("button");
del.innerText="ðŸ—‘";
del.onclick=()=>db.ref("messages/"+currentChat+"/"+s.key).remove();
div.appendChild(del);

let seen=document.createElement("div");
seen.className="seen";
seen.innerText=m.seen?"Seen":"Sent";
div.appendChild(seen);
}else{
db.ref("messages/"+currentChat+"/"+s.key+"/seen").set(true);
}

chat.appendChild(div);
});
chat.scrollTop=chat.scrollHeight;
});
}

/* ================= TYPING ================= */

function typingNow(){
if(!currentChat)return;
db.ref("typing/"+currentChat+"/"+me.uid).set(true);
setTimeout(()=>{
db.ref("typing/"+currentChat+"/"+me.uid).remove();
},1000);
}

function listenTyping(){
db.ref("typing/"+currentChat+"/"+currentOther).on("value",snap=>{
typing.innerText=snap.exists()?"Typing...":"";
});
}

/* ================= STATUS ================= */

function toggleStatus(){
db.ref("users/"+me.uid+"/online").once("value",snap=>{
let newStatus=!snap.val();
db.ref("users/"+me.uid+"/online").set(newStatus);
statusText.innerText=newStatus?"Online":"Offline";
});
}

/* ================= PROFILE ================= */

function openProfile(){
db.ref("users/"+me.uid).once("value",snap=>{
let data=snap.val();
pName.innerText=data.email.split("@")[0];
pEmail.innerText=data.email;
pStatus.innerText=data.online?"Online":"Offline";
profileModal.style.display="block";
});
}
function closeProfile(){
profileModal.style.display="none";
}
</script>

</body>
</html>
