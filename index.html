<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Khaji Social</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- PeerJS for Video Calls -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: { fb: '#1877f2', fbHover: '#166fe5' }
        }
      }
    }
  </script>
  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
      onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, onSnapshot, query, 
      where, serverTimestamp, doc, setDoc, getDoc, getDocs, 
      updateDoc, arrayUnion, arrayRemove, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
      getStorage, ref, uploadBytes, getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBtPQ_HcTZtqlPuQ11awTUOIiPjvpMNWlU",
      authDomain: "khaji-23a99.firebaseapp.com",
      projectId: "khaji-23a99",
      storageBucket: "khaji-23a99.appspot.com",
      messagingSenderId: "84794766200",
      appId: "1:84794766200:web:6f67917ca967334675ce8d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- DOM Elements ---
    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");
    
    // Login/Register
    const emailIn = document.getElementById("emailIn");
    const passIn = document.getElementById("passIn");
    const nameIn = document.getElementById("nameIn");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const showLoginBtn = document.getElementById("showLoginBtn");
    const showRegBtn = document.getElementById("showRegBtn");
    const loginForm = document.getElementById("loginForm");
    const regForm = document.getElementById("regForm");

    // App
    const userNameEl = document.getElementById("userName");
    const userPicEl = document.getElementById("userPic");
    const logoutBtn = document.getElementById("logoutBtn");
    const postsContainer = document.getElementById("postsContainer");
    const postInput = document.getElementById("postInput");
    const postBtn = document.getElementById("postBtn");
    
    // Friends & Chat
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");
    const requestsContainer = document.getElementById("requestsContainer");
    const friendsContainer = document.getElementById("friendsContainer");
    const chatBox = document.getElementById("chatBox");
    const chatTitle = document.getElementById("chatTitle");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const sendMsgBtn = document.getElementById("sendMsgBtn");
    const videoBtn = document.getElementById("videoBtn");
    const closeChatBtn = document.getElementById("closeChatBtn");
    
    // Video Modal
    const videoModal = document.getElementById("videoModal");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const endCallBtn = document.getElementById("endCallBtn");

    // --- State ---
    let currentUser = null;
    let currentChatId = null;
    let peer = null;
    let myStream = null;

    // --- 1. Auth System ---
    
    // Toggle Forms
    showRegBtn.onclick = () => { loginForm.classList.add('hidden'); regForm.classList.remove('hidden'); };
    showLoginBtn.onclick = () => { regForm.classList.add('hidden'); loginForm.classList.remove('hidden'); };

    // Register (Create Account with Custom Password)
    registerBtn.onclick = async () => {
      const name = nameIn.value;
      const email = emailIn.value;
      const password = passIn.value; // User sets their own password

      if(!email || !password || !name) return alert("Please fill all fields");

      try {
        registerBtn.innerText = "Creating...";
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        
        // Save user to Firestore
        await setDoc(doc(db, "users", cred.user.uid), {
          uid: cred.user.uid,
          name: name,
          email: email,
          photoURL: "",
          online: true,
          friends: [],
          requests: []
        });
        // Auth state change will handle the redirect
      } catch(e) {
        alert(e.message);
        registerBtn.innerText = "Create Account";
      }
    };

    // Login
    loginBtn.onclick = async () => {
      const email = emailIn.value;
      const password = passIn.value;
      if(!email || !password) return alert("Enter email and password");

      try {
        loginBtn.innerText = "Signing In...";
        await signInWithEmailAndPassword(auth, email, password);
      } catch(e) {
        alert("Login Failed: " + e.message);
        loginBtn.innerText = "Log In";
      }
    };

    // Logout
    logoutBtn.onclick = async () => {
      if(currentUser) {
         await updateDoc(doc(db, "users", currentUser.uid), { online: false });
      }
      await signOut(auth);
    };

    // Auth State Listener (Controls App Flow)
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in -> Open App
        loginView.classList.add("hidden");
        appView.classList.remove("hidden");
        
        currentUser = user;
        
        // Initialize PeerJS for calls
        initPeer(user.uid);
        
        // Update UI
        await loadUserData(user.uid);
        loadPosts();
        loadFriendsAndRequests();
        
        // Set Online Status
        await updateDoc(doc(db, "users", user.uid), { online: true });
        
        // Handle window close -> Offline
        window.onbeforeunload = async () => {
           await updateDoc(doc(db, "users", currentUser.uid), { online: false });
        };

      } else {
        // User is signed out -> Show Login
        loginView.classList.remove("hidden");
        appView.classList.add("hidden");
        currentUser = null;
      }
    });

    async function loadUserData(uid) {
        const snap = await getDoc(doc(db, "users", uid));
        if(snap.exists()) {
            const data = snap.data();
            userNameEl.innerText = data.name;
            userPicEl.src = data.photoURL || `https://ui-avatars.com/api/?name=${data.name}&background=1877f2&color=fff`;
        }
    }

    // --- 2. Posts (Feed) ---
    postBtn.onclick = async () => {
        const text = postInput.value.trim();
        if(!text) return;
        
        const userSnap = await getDoc(doc(db, "users", currentUser.uid));
        const userData = userSnap.data();

        await addDoc(collection(db, "posts"), {
            text: text,
            uid: currentUser.uid,
            userName: userData.name,
            userPhoto: userData.photoURL || "",
            timestamp: serverTimestamp(),
            likes: []
        });
        postInput.value = "";
    };

    function loadPosts() {
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            postsContainer.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                const time = p.timestamp ? new Date(p.timestamp.toDate()).toLocaleString() : "Just now";
                const isLiked = p.likes?.includes(currentUser.uid);
                
                postsContainer.innerHTML += `
                <div class="bg-white rounded-lg shadow p-4 mb-3">
                    <div class="flex items-center gap-2 mb-2">
                        <img src="${p.userPhoto || `https://ui-avatars.com/api/?name=${p.userName}`}" class="w-10 h-10 rounded-full">
                        <div>
                            <h3 class="font-semibold text-sm">${p.userName}</h3>
                            <p class="text-xs text-gray-500">${time}</p>
                        </div>
                    </div>
                    <p class="text-gray-800 mb-3">${p.text}</p>
                    <div class="border-t pt-2 flex gap-4">
                        <button onclick="toggleLike('${d.id}', ${isLiked})" class="flex items-center gap-1 text-sm ${isLiked ? 'text-fb font-bold' : 'text-gray-500'}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"></path></svg>
                            Like ${p.likes?.length || 0}
                        </button>
                    </div>
                </div>`;
            });
        });
    }

    window.toggleLike = async (id, isLiked) => {
        const ref = doc(db, "posts", id);
        if(isLiked) {
            await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
        } else {
            await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
        }
    };

    // --- 3. Friend System ---
    
    // Search Users
    searchInput.oninput = async () => {
        const term = searchInput.value.toLowerCase();
        searchResults.innerHTML = "";
        if(!term) return;

        // Simple client-side filter for demo (Use Firestore indexing in prod)
        const snap = await getDocs(collection(db, "users"));
        snap.forEach(d => {
            const u = d.data();
            if(u.uid !== currentUser.uid && u.name.toLowerCase().includes(term)) {
                const isFriend = currentUser.data().friends?.includes(u.uid);
                searchResults.innerHTML += `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded mb-1">
                    <div class="flex items-center gap-2">
                        <img src="${u.photoURL || `https://ui-avatars.com/api/?name=${u.name}`}" class="w-8 h-8 rounded-full">
                        <span class="text-sm font-medium">${u.name}</span>
                    </div>
                    ${isFriend 
                        ? '<span class="text-xs text-green-600 font-bold">Friend</span>' 
                        : `<button onclick="sendReq('${u.uid}')" class="text-xs bg-fb text-white px-2 py-1 rounded">Add</button>`}
                </div>`;
            }
        });
    };
    
    // We need to have currentUser data populated first
    async function loadFriendsAndRequests() {
        onSnapshot(doc(db, "users", currentUser.uid), async (snap) => {
            currentUser = { ...currentUser, ...snap.data() }; // Update local state
            
            // Render Requests
            requestsContainer.innerHTML = "";
            if(currentUser.requests?.length > 0) {
                for(let req of currentUser.requests) {
                    requestsContainer.innerHTML += `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm">${req.name}</span>
                        <div class="gap-1 flex">
                            <button onclick="acceptReq('${req.uid}')" class="text-xs bg-green-500 text-white px-2 py-1 rounded">Confirm</button>
                        </div>
                    </div>`;
                }
            } else {
                requestsContainer.innerHTML = "<p class='text-xs text-gray-400'>No new requests.</p>";
            }

            // Render Friends List
            friendsContainer.innerHTML = "";
            if(currentUser.friends?.length > 0) {
                for(let fid of currentUser.friends) {
                    const fSnap = await getDoc(doc(db, "users", fid));
                    if(fSnap.exists()) {
                        const f = fSnap.data();
                        const statusColor = f.online ? 'bg-green-500' : 'bg-gray-400';
                        friendsContainer.innerHTML += `
                        <div onclick="openChat('${f.uid}', '${f.name}')" class="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer relative">
                            <img src="${f.photoURL || `https://ui-avatars.com/api/?name=${f.name}`}" class="w-9 h-9 rounded-full">
                            <span class="text-sm font-medium">${f.name}</span>
                            <span class="absolute left-7 bottom-0 w-3 h-3 border-2 border-white rounded-full ${statusColor}"></span>
                        </div>`;
                    }
                }
            }
        });
    }

    window.sendReq = async (toUid) => {
        const myData = await getDoc(doc(db, "users", currentUser.uid));
        await updateDoc(doc(db, "users", toUid), {
            requests: arrayUnion({ uid: currentUser.uid, name: myData.data().name })
        });
        alert("Request Sent!");
        searchResults.innerHTML = "";
        searchInput.value = "";
    };

    window.acceptReq = async (fromUid) => {
        // Remove request
        const updatedRequests = currentUser.requests.filter(r => r.uid !== fromUid);
        await updateDoc(doc(db, "users", currentUser.uid), { 
            requests: updatedRequests,
            friends: arrayUnion(fromUid)
        });
        // Add me to their friends list
        await updateDoc(doc(db, "users", fromUid), {
            friends: arrayUnion(currentUser.uid)
        });
    };

    // --- 4. Chat System ---
    
    window.openChat = async (friendId, friendName) => {
        currentChatId = [currentUser.uid, friendId].sort().join('_');
        chatBox.classList.remove("hidden");
        chatBox.classList.add("slide-up");
        chatTitle.innerText = friendName;
        videoBtn.setAttribute("data-fid", friendId);
        
        // Listen for messages
        onSnapshot(query(collection(db, "chats", currentChatId, "messages"), orderBy("timestamp")), (snap) => {
            chatMessages.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const isMe = m.senderId === currentUser.uid;
                chatMessages.innerHTML += `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'} mb-2">
                    <div class="${isMe ? 'bg-fb text-white' : 'bg-gray-200'} px-3 py-1 rounded-lg max-w-xs">
                        <p class="text-sm">${m.text}</p>
                    </div>
                </div>`;
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    };

    sendMsgBtn.onclick = async () => {
        const text = chatInput.value.trim();
        if(!text || !currentChatId) return;
        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            text: text,
            senderId: currentUser.uid,
            timestamp: serverTimestamp()
        });
        chatInput.value = "";
    };
    
    closeChatBtn.onclick = () => chatBox.classList.add("hidden");

    // --- 5. Video Call (WebRTC via PeerJS) ---
    
    function initPeer(uid) {
        peer = new Peer(uid);
        peer.on('open', (id) => console.log('Peer ready:', id));
        
        peer.on('call', (call) => {
            // Incoming call
            if(confirm("Incoming video call. Answer?")) {
                openVideoModal();
                navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                    myStream = stream;
                    localVideo.srcObject = stream;
                    call.answer(stream);
                    call.on('stream', remoteStream => {
                        remoteVideo.srcObject = remoteStream;
                    });
                }).catch(err => alert("Camera access denied"));
            }
        });
    }

    videoBtn.onclick = () => {
        const friendId = videoBtn.getAttribute("data-fid");
        if(!friendId) return;
        
        openVideoModal();
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
            myStream = stream;
            localVideo.srcObject = stream;
            
            const call = peer.call(friendId, stream);
            call.on('stream', remoteStream => {
                remoteVideo.srcObject = remoteStream;
            });
        }).catch(err => alert("Camera access denied"));
    };

    function openVideoModal() {
        videoModal.classList.remove("hidden");
    }

    endCallBtn.onclick = () => {
        if(myStream) myStream.getTracks().forEach(t => t.stop());
        videoModal.classList.add("hidden");
    };

  </script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Video Modal -->
  <div id="videoModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center flex-col">
    <div class="flex gap-2 w-full max-w-4xl h-96 p-4">
        <video id="localVideo" autoplay muted playsinline class="w-1/2 bg-black rounded-lg object-cover"></video>
        <video id="remoteVideo" autoplay playsinline class="w-1/2 bg-gray-900 rounded-lg object-cover"></video>
    </div>
    <button id="endCallBtn" class="mt-4 bg-red-600 text-white px-6 py-2 rounded-full font-bold hover:bg-red-700">End Call</button>
  </div>

  <!-- LOGIN / REGISTER VIEW -->
  <div id="loginView" class="min-h-screen flex items-center justify-center bg-gray-200">
    <div class="bg-white p-8 rounded-lg shadow-xl w-96">
        <h1 class="text-4xl font-bold text-fb text-center mb-6">khaji</h1>
        
        <!-- Login Form -->
        <div id="loginForm">
            <input id="emailIn" type="email" placeholder="Email" class="w-full p-3 mb-3 border rounded-lg focus:outline-none focus:ring-2 ring-fb">
            <input id="passIn" type="password" placeholder="Password" class="w-full p-3 mb-3 border rounded-lg focus:outline-none focus:ring-2 ring-fb">
            <button id="loginBtn" class="w-full bg-fb text-white py-3 rounded-lg font-bold hover:bg-fbHover transition">Log In</button>
            <hr class="my-4">
            <button id="showRegBtn" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600">Create New Account</button>
        </div>

        <!-- Register Form -->
        <div id="regForm" class="hidden">
            <h2 class="text-xl font-bold mb-3 text-center">Sign Up</h2>
            <p class="text-xs text-gray-500 mb-2 text-center">It's free and always will be.</p>
            <input id="nameIn" type="text" placeholder="Full Name" class="w-full p-3 mb-3 border rounded-lg">
            <input id="emailIn" type="email" placeholder="Email" class="w-full p-3 mb-3 border rounded-lg">
            <input id="passIn" type="password" placeholder="New Password" class="w-full p-3 mb-3 border rounded-lg">
            <button id="registerBtn" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600">Sign Up</button>
            <button id="showLoginBtn" class="w-full mt-3 text-fb text-sm hover:underline">Already have an account?</button>
        </div>
    </div>
  </div>

  <!-- MAIN APP VIEW (Facebook Style) -->
  <div id="appView" class="hidden min-h-screen bg-gray-100">
    
    <!-- Top Navbar -->
    <nav class="bg-fb h-14 flex items-center justify-between px-4 sticky top-0 z-40 shadow">
        <div class="flex items-center gap-2 flex-1">
            <h1 class="text-3xl text-white font-bold">khaji</h1>
            <div class="relative ml-2 hidden md:block">
                <input id="searchInput" type="text" placeholder="Search friends..." class="bg-gray-100 rounded-full px-4 py-2 text-sm w-64 focus:outline-none">
                <div id="searchResults" class="absolute top-full left-0 w-full bg-white shadow-lg rounded-lg mt-1 z-50 max-h-64 overflow-y-auto"></div>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <img id="userPic" src="" class="w-8 h-8 rounded-full border-2 border-white object-cover">
                <span id="userName" class="text-white font-semibold hidden md:block"></span>
            </div>
            <button id="logoutBtn" class="bg-gray-200 text-gray-700 px-4 py-1 rounded font-medium text-sm hover:bg-gray-300">Logout</button>
        </div>
    </nav>

    <!-- Main Content Grid -->
    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-4 py-4 px-2">
        
        <!-- Left Sidebar (Profile & Requests) -->
        <div class="space-y-4">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center gap-3">
                    <img id="userPicSidebar" src="" class="w-12 h-12 rounded-full">
                    <h2 id="userNameSidebar" class="font-bold"></h2>
                </div>
            </div>
            
            <!-- Friend Requests -->
            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="font-bold text-gray-600 border-b pb-2 mb-2">Friend Requests</h3>
                <div id="requestsContainer"></div>
            </div>
        </div>

        <!-- Center (Feed) -->
        <div class="col-span-2 space-y-4">
            <!-- Create Post -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex gap-2">
                    <img id="postAvatar" src="" class="w-10 h-10 rounded-full">
                    <input id="postInput" type="text" placeholder="What's on your mind?" class="bg-gray-100 rounded-full px-4 py-2 flex-1 focus:outline-none">
                </div>
                <button id="postBtn" class="w-full mt-2 bg-fb text-white py-1 rounded font-semibold">Post</button>
            </div>
            
            <!-- Posts Feed -->
            <div id="postsContainer"></div>
        </div>

        <!-- Right Sidebar (Contacts/Friends) -->
        <div class="bg-white rounded-lg shadow p-4 h-max sticky top-20">
            <h3 class="font-bold text-gray-600 mb-2">Contacts</h3>
            <div id="friendsContainer" class="space-y-1 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

  </div>

  <!-- Floating Chat Box -->
  <div id="chatBox" class="hidden fixed bottom-0 right-4 w-80 bg-white shadow-2xl rounded-t-lg border z-40 flex flex-col h-96">
      <div class="bg-fb p-3 rounded-t-lg flex justify-between items-center cursor-pointer">
          <h3 id="chatTitle" class="text-white font-semibold"></h3>
          <div class="flex gap-2">
              <button id="videoBtn" data-fid="" class="text-white hover:scale-110"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button>
              <button id="closeChatBtn" class="text-white hover:scale-110"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
          </div>
      </div>
      <div id="chatMessages" class="flex-1 p-3 overflow-y-auto bg-gray-50 space-y-2"></div>
      <div class="p-2 border-t flex gap-2">
          <input id="chatInput" type="text" placeholder="Type a message..." class="flex-1 border rounded-full px-3 py-1 text-sm focus:outline-none focus:ring-1 ring-fb">
          <button id="sendMsgBtn" class="bg-fb text-white rounded-full p-2 hover:bg-fbHover"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg></button>
      </div>
  </div>

</body>
</html>
