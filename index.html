<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social App</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    window.auth = getAuth(app);
    window.db = getFirestore(app);
    window.storage = getStorage(app);
  </script>
</head>
<body class="bg-gray-100 font-sans">

<!-- Container -->
<div class="max-w-5xl mx-auto p-4">

  <!-- ðŸ” Auth Section -->
  <div id="authSection" class="bg-white p-6 rounded shadow-md mt-8">
    <h1 class="text-2xl font-bold mb-4">Login / Register</h1>
    <input id="email" type="email" placeholder="Email" class="border p-2 rounded w-full mb-2">
    <input id="password" type="password" placeholder="Password" class="border p-2 rounded w-full mb-4">
    <div class="flex gap-2">
      <button onclick="register()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Register</button>
      <button onclick="login()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Login</button>
    </div>
  </div>

  <!-- ðŸ“° Feed Section -->
  <div id="feedSection" class="hidden mt-8">
    <h2 class="text-xl font-bold mb-2">Create Post</h2>
    <textarea id="postText" placeholder="Write something..." class="border p-2 rounded w-full mb-2"></textarea>
    <button onclick="addPost()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">Post</button>
    <div id="posts" class="mt-4 space-y-2"></div>
  </div>

  <!-- ðŸ’¬ Chat Section -->
  <div id="chatSection" class="hidden mt-8 bg-white p-4 rounded shadow-md">
    <h2 class="text-xl font-bold mb-2">Global Chat</h2>
    <div id="chatBox" class="h-48 overflow-y-scroll border p-2 rounded mb-2 bg-gray-50"></div>
    <div class="flex gap-2">
      <input id="message" placeholder="Type message..." class="border p-2 rounded flex-1">
      <button onclick="sendMessage()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">Send</button>
    </div>
  </div>

  <!-- ðŸ“¹ Video Call Section -->
  <div id="videoSection" class="hidden mt-8 bg-white p-4 rounded shadow-md">
    <h2 class="text-xl font-bold mb-2">Video Call</h2>
    <div class="flex gap-4">
      <video id="localVideo" autoplay muted class="w-1/2 rounded shadow"></video>
      <video id="remoteVideo" autoplay class="w-1/2 rounded shadow"></video>
    </div>
    <button onclick="startCall()" class="mt-2 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Start Call</button>
  </div>

</div>

<!-- JS Logic -->
<script type="module">
  import { createUserWithEmailAndPassword, signInWithEmailAndPassword } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { collection, addDoc, onSnapshot } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Sections
  const authSection = document.getElementById('authSection');
  const feedSection = document.getElementById('feedSection');
  const chatSection = document.getElementById('chatSection');
  const videoSection = document.getElementById('videoSection');

  // ------------------- Authentication -------------------
  window.register = async () => {
    try {
      const emailVal = document.getElementById('email').value;
      const passwordVal = document.getElementById('password').value;
      await createUserWithEmailAndPassword(auth, emailVal, passwordVal);
      alert("Registered Successfully");
      showApp();
    } catch(e) { alert(e.message) }
  };

  window.login = async () => {
    try {
      const emailVal = document.getElementById('email').value;
      const passwordVal = document.getElementById('password').value;
      await signInWithEmailAndPassword(auth, emailVal, passwordVal);
      showApp();
    } catch(e) { alert(e.message) }
  };

  const showApp = () => {
    authSection.classList.add('hidden');
    feedSection.classList.remove('hidden');
    chatSection.classList.remove('hidden');
    videoSection.classList.remove('hidden');
    initPosts();
    initChat();
    initVideo();
  };

  // ------------------- Posts -------------------
  const postsDiv = document.getElementById('posts');
  const postsCol = collection(db, "posts");

  window.addPost = async () => {
    const text = document.getElementById('postText').value;
    if(!text) return;
    await addDoc(postsCol, {
      userId: auth.currentUser.uid,
      text,
      createdAt: Date.now()
    });
    document.getElementById('postText').value = "";
  };

  const initPosts = () => {
    onSnapshot(postsCol, snapshot => {
      postsDiv.innerHTML = "";
      snapshot.forEach(doc => {
        postsDiv.innerHTML += `<div class="bg-gray-50 p-2 rounded shadow">${doc.data().text}</div>`;
      });
    });
  };

  // ------------------- Chat -------------------
  const chatBox = document.getElementById('chatBox');
  const chatCol = collection(db, "chats", "globalChat", "messages");

  window.sendMessage = async () => {
    const msg = document.getElementById('message').value;
    if(!msg) return;
    await addDoc(chatCol, {
      sender: auth.currentUser.uid,
      text: msg,
      createdAt: Date.now()
    });
    document.getElementById('message').value = "";
  };

  const initChat = () => {
    onSnapshot(chatCol, snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        chatBox.innerHTML += `<p class="p-1 bg-gray-100 rounded mb-1">${doc.data().text}</p>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  };

  // ------------------- Video Call -------------------
  let pc;
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');

  const initVideo = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = stream;
    pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
    pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; };
  };

  window.startCall = async () => {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    alert("Offer created! Implement Firestore signaling for real video call.");
  };
</script>

</body>
</html>
