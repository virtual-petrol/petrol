<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Khaji Social App</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // ðŸ”¹ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBtPQ_HcTZtqlPuQ11awTUOIiPjvpMNWlU",
      authDomain: "khaji-23a99.firebaseapp.com",
      projectId: "khaji-23a99",
      storageBucket: "khaji-23a99.appspot.com",
      messagingSenderId: "84794766200",
      appId: "1:84794766200:web:6f67917ca967334675ce8d",
      measurementId: "G-QQQQ2ERH10"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---------------- DOM Elements ----------------
    const loginSection = document.getElementById("loginSection");
    const appSection = document.getElementById("appSection");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const nameInput = document.getElementById("name");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const postInput = document.getElementById("postInput");
    const postBtn = document.getElementById("postBtn");
    const postsDiv = document.getElementById("posts");
    const fileInput = document.getElementById("profilePic");

    // ---------------- Auth Functions ----------------
    registerBtn.onclick = async () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      const name = nameInput.value || "Anonymous";
      if(!email || !password) return alert("Email & Password required");

      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;

      // Create user profile in Firestore
      await setDoc(doc(db, "users", uid), {
        name,
        email,
        online: true,
        createdAt: serverTimestamp(),
        photoURL: ""
      });
    };

    loginBtn.onclick = async () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      if(!email || !password) return alert("Email & Password required");
      await signInWithEmailAndPassword(auth, email, password);
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    // ---------------- Auth State ----------------
    onAuthStateChanged(auth, async user => {
      if(user){
        loginSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        // Set online status
        await setDoc(doc(db, "users", user.uid), {online:true}, {merge:true});
        initPosts();
      } else {
        loginSection.classList.remove("hidden");
        appSection.classList.add("hidden");
      }
    });

    // ---------------- Posts ----------------
    postBtn.onclick = async () => {
      const text = postInput.value;
      if(!text) return;
      await addDoc(collection(db, "posts"), {
        text,
        userId: auth.currentUser.uid,
        createdAt: serverTimestamp()
      });
      postInput.value = "";
    };

    function initPosts(){
      const postsCol = collection(db, "posts");
      onSnapshot(postsCol, snapshot => {
        postsDiv.innerHTML = "";
        snapshot.forEach(doc => {
          postsDiv.innerHTML += `<div class="p-2 bg-gray-100 rounded mb-2">${doc.data().text}</div>`;
        });
      });
    }

    // ---------------- Profile Picture Upload ----------------
    fileInput.onchange = async () => {
      const file = fileInput.files[0];
      if(!file) return;
      const storageRef = ref(storage, `profilePics/${auth.currentUser.uid}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      await setDoc(doc(db, "users", auth.currentUser.uid), {photoURL: url}, {merge:true});
      alert("Profile Picture Uploaded!");
    };

  </script>
</head>
<body class="bg-gray-100 p-4 font-sans">

  <!-- ðŸ” Login/Register -->
  <div id="loginSection" class="max-w-md mx-auto bg-white p-6 rounded shadow mt-8">
    <h1 class="text-2xl font-bold mb-4">Login / Register</h1>
    <input id="name" type="text" placeholder="Name (for register)" class="border p-2 rounded w-full mb-2">
    <input id="email" type="email" placeholder="Email" class="border p-2 rounded w-full mb-2">
    <input id="password" type="password" placeholder="Password" class="border p-2 rounded w-full mb-4">
    <div class="flex gap-2">
      <button id="registerBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Register</button>
      <button id="loginBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Login</button>
    </div>
  </div>

  <!-- ðŸŒ App Section -->
  <div id="appSection" class="hidden max-w-3xl mx-auto mt-8">

    <div class="flex justify-between mb-4">
      <h2 class="text-xl font-bold">Welcome!</h2>
      <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
    </div>

    <!-- Profile Pic -->
    <div class="mb-4">
      <input id="profilePic" type="file">
    </div>

    <!-- Post -->
    <div class="mb-4">
      <textarea id="postInput" placeholder="Write something..." class="border p-2 rounded w-full mb-2"></textarea>
      <button id="postBtn" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">Post</button>
    </div>

    <!-- Posts Feed -->
    <div id="posts" class="space-y-2"></div>

  </div>

</body>
</html>
