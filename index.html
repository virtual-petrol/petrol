<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectChat - Friend Requests & Video Calls</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            width: 95%;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Login/Register Section */
        .auth-section {
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .auth-section h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .auth-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 50px;
            padding: 5px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 25px;
            background: white;
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            margin-top: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        /* Main App Section */
        .app-section {
            display: none;
            height: 600px;
        }

        .sidebar {
            width: 300px;
            background: #f5f5f5;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .user-profile {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .user-profile:hover {
            background: #f0f0f0;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .user-info {
            flex: 1;
        }

        .user-info h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .user-info p {
            font-size: 14px;
            color: #666;
        }

        .status-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .status-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .status-toggle label {
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        .logout-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .logout-btn:hover {
            color: #f44336;
        }

        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
        }

        .friend-request-badge {
            background: #f44336;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }

        .user-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.3s;
            border-bottom: 1px solid #eee;
        }

        .user-item:hover {
            background: #e8e8e8;
        }

        .user-item.active {
            background: #e3e3e3;
        }

        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            margin-left: auto;
        }

        .user-status.offline {
            background: #9e9e9e;
        }

        .friend-request-actions {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .accept-btn-small {
            background: #4caf50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .reject-btn-small {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-friend-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .chat-user-info:hover {
            opacity: 0.8;
        }

        .call-buttons {
            display: flex;
            gap: 10px;
        }

        .call-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .video-call-btn {
            background: #4caf50;
            color: white;
        }

        .audio-call-btn {
            background: #2196f3;
            color: white;
        }

        .call-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .call-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9f9f9;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }

        .message.sent .message-content {
            background: #667eea;
            color: white;
        }

        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .message-image:hover {
            transform: scale(1.05);
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
        }

        .chat-input button {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            background: #667eea;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .chat-input button:hover {
            background: #5a67d8;
        }

        .chat-input button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .image-upload-btn {
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .image-upload-btn:hover {
            background: #2d3748;
        }

        /* Profile Modal */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .profile-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        .profile-info h2 {
            margin-bottom: 5px;
        }

        .profile-info p {
            color: #666;
            margin-bottom: 5px;
        }

        .profile-field {
            margin-bottom: 15px;
        }

        .profile-field label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .profile-field input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            outline: none;
        }

        .profile-field input:focus {
            border-color: #667eea;
        }

        .profile-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .profile-close:hover {
            color: #333;
        }

        .profile-save-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .profile-save-btn:hover {
            background: #5a67d8;
        }

        /* Video Call Modal */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
        }

        .video-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .video-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 20px;
        }

        .video-wrapper {
            position: relative;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
        }

        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
        }

        .call-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            background: rgba(255,255,255,0.1);
            padding: 15px 30px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .control-btn.end-call {
            background: #f44336;
        }

        .control-btn.end-call:hover {
            background: #d32f2f;
        }

        .incoming-call-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 1001;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .incoming-call-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .accept-btn {
            padding: 10px 30px;
            border: none;
            border-radius: 25px;
            background: #4caf50;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .reject-btn {
            padding: 10px 30px;
            border: none;
            border-radius: 25px;
            background: #f44336;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #333;
            color: white;
            border-radius: 10px;
            animation: slideIn 0.3s;
            z-index: 1002;
        }

        /* Image Preview Modal */
        .image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }

        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
        }

        .image-preview-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .image-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login/Register Section -->
        <div class="auth-section" id="authSection">
            <h1>ü§ù ConnectChat</h1>
            <p>Connect with friends through friend requests, chat, and video calls</p>
            
            <div class="auth-form">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
                </div>
                
                <div id="loginForm">
                    <div class="input-group">
                        <input type="email" id="loginEmail" placeholder="Email" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="loginPassword" placeholder="Password" required>
                    </div>
                    <button class="auth-btn" onclick="loginWithEmail()">Login</button>
                </div>
                
                <div id="registerForm" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="regName" placeholder="Full Name" required>
                    </div>
                    <div class="input-group">
                        <input type="email" id="regEmail" placeholder="Email" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="regPassword" placeholder="Password" required>
                    </div>
                    <button class="auth-btn" onclick="registerWithEmail()">Register</button>
                </div>
            </div>
        </div>

        <!-- Main App Section -->
        <div class="app-section" id="appSection">
            <div style="display: flex; height: 100%;">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="user-profile" onclick="showProfileModal()">
                        <div class="avatar" id="userAvatar">JD</div>
                        <div class="user-info">
                            <h3 id="userName">Loading...</h3>
                            <div class="status-toggle">
                                <input type="checkbox" id="onlineStatus" checked onchange="toggleOnlineStatus()">
                                <label for="onlineStatus">Online</label>
                            </div>
                        </div>
                        <button class="logout-btn" onclick="logout(event)">üö™</button>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('friends')" id="friendsTab">Friends</div>
                        <div class="tab" onclick="switchTab('requests')" id="requestsTab">
                            Requests <span class="friend-request-badge" id="requestBadge" style="display: none;">0</span>
                        </div>
                        <div class="tab" onclick="switchTab('search')" id="searchTab">Search</div>
                    </div>
                    
                    <div class="tab-content" id="tabContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>

                <!-- Main Chat Area -->
                <div class="main-content">
                    <div class="chat-header">
                        <div class="chat-user-info" onclick="showFriendProfile()">
                            <div class="avatar" id="chatUserAvatar">?</div>
                            <div>
                                <h3 id="chatUserName">Select a friend</h3>
                                <p id="chatUserStatus">...</p>
                            </div>
                        </div>
                        <div class="call-buttons">
                            <button class="call-btn video-call-btn" onclick="startVideoCall()" id="videoCallBtn" disabled>üìπ Video Call</button>
                            <button class="call-btn audio-call-btn" onclick="startAudioCall()" id="audioCallBtn" disabled>üé§ Audio Call</button>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will appear here -->
                    </div>

                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)" disabled>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="sendImage()">
                        <button class="image-upload-btn" onclick="document.getElementById('imageInput').click()" id="imageUploadBtn" disabled>üì∑</button>
                        <button onclick="sendMessage()" id="sendBtn" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <button class="profile-close" onclick="hideProfileModal()">&times;</button>
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">JD</div>
                <div class="profile-info">
                    <h2 id="profileName">John Doe</h2>
                    <p id="profileEmail">john@example.com</p>
                </div>
            </div>
            <div class="profile-field">
                <label>Display Name</label>
                <input type="text" id="profileDisplayName" placeholder="Enter your name">
            </div>
            <div class="profile-field">
                <label>Bio</label>
                <input type="text" id="profileBio" placeholder="Tell something about yourself">
            </div>
            <div class="profile-field">
                <label>Status</label>
                <input type="text" id="profileStatus" placeholder="e.g., Coding, Gaming, etc.">
            </div>
            <button class="profile-save-btn" onclick="saveProfile()">Save Changes</button>
        </div>
    </div>

    <!-- Friend Profile Modal -->
    <div class="profile-modal" id="friendProfileModal">
        <div class="profile-content">
            <button class="profile-close" onclick="hideFriendProfileModal()">&times;</button>
            <div class="profile-header">
                <div class="profile-avatar" id="friendProfileAvatar">JD</div>
                <div class="profile-info">
                    <h2 id="friendProfileName">Friend Name</h2>
                    <p id="friendProfileEmail">friend@example.com</p>
                </div>
            </div>
            <div class="profile-field">
                <label>Bio</label>
                <p id="friendProfileBio">No bio available</p>
            </div>
            <div class="profile-field">
                <label>Status</label>
                <p id="friendProfileStatus">No status available</p>
            </div>
            <div class="profile-field">
                <label>Last Seen</label>
                <p id="friendProfileLastSeen">Unknown</p>
            </div>
        </div>
    </div>

    <!-- Video Call Modal -->
    <div class="video-modal" id="videoModal">
        <div class="video-container">
            <div class="video-grid" id="videoGrid">
                <div class="video-wrapper" id="localVideoWrapper">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="video-label">You</div>
                </div>
                <div class="video-wrapper" id="remoteVideoWrapper">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="video-label" id="remoteVideoLabel">Remote User</div>
                </div>
            </div>
            <div class="call-controls">
                <button class="control-btn" onclick="toggleMute()" id="muteBtn">üé§</button>
                <button class="control-btn" onclick="toggleVideo()" id="videoBtn">üìπ</button>
                <button class="control-btn end-call" onclick="endCall()">üìû</button>
            </div>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div class="incoming-call-modal" id="incomingCallModal">
        <h2 id="incomingCaller">Incoming Call...</h2>
        <p id="callType">Video Call</p>
        <div class="incoming-call-buttons">
            <button class="accept-btn" onclick="acceptCall()">Accept</button>
            <button class="reject-btn" onclick="rejectCall()">Reject</button>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="image-preview-modal" id="imagePreviewModal" onclick="hideImagePreview()">
        <div class="image-preview-content">
            <img id="previewImage" src="" alt="Preview">
        </div>
        <div class="image-preview-close" onclick="hideImagePreview()">&times;</div>
    </div>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtPQ_HcTZtqlPuQ11awTUOIiPjvpMNWlU",
            authDomain: "khaji-23a99.firebaseapp.com",
            databaseURL: "https://khaji-23a99-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "khaji-23a99",
            storageBucket: "khaji-23a99.firebasestorage.app",
            messagingSenderId: "84794766200",
            appId: "1:84794766200:web:207a50412961d45275ce8d",
            measurementId: "G-2RE1L7HQTZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let selectedUser = null;
        let currentChatId = null;
        let currentTab = 'friends';
        
        // WebRTC variables
        let localStream = null;
        let peerConnection = null;
        let isCallActive = false;
        let callType = null;
        let incomingCall = null;
        let callDocId = null;
        
        // Configuration for WebRTC
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                currentUser = {
                    uid: user.uid,
                    name: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    online: document.getElementById('onlineStatus').checked
                };
                
                // Save user to database
                await database.ref('users/' + user.uid).set({
                    name: currentUser.name,
                    email: currentUser.email,
                    online: currentUser.online,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    bio: user.bio || '',
                    status: user.status || ''
                });
                
                // Set user as offline when disconnected
                database.ref('users/' + user.uid + '/online').onDisconnect().set(false);
                database.ref('users/' + user.uid + '/lastSeen').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                
                showApp();
                loadFriends();
                listenForFriendRequests();
                listenForCalls();
                
                // Load user profile data
                loadUserProfile();
            } else {
                showAuth();
            }
        });

        // Load user profile data
        async function loadUserProfile() {
            if (!currentUser) return;
            
            const snapshot = await database.ref('users/' + currentUser.uid).once('value');
            const userData = snapshot.val();
            
            if (userData) {
                document.getElementById('profileDisplayName').value = userData.name || '';
                document.getElementById('profileBio').value = userData.bio || '';
                document.getElementById('profileStatus').value = userData.status || '';
            }
        }

        // Show profile modal
        function showProfileModal() {
            document.getElementById('profileModal').style.display = 'flex';
        }

        // Hide profile modal
        function hideProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        // Save profile
        async function saveProfile() {
            const name = document.getElementById('profileDisplayName').value;
            const bio = document.getElementById('profileBio').value;
            const status = document.getElementById('profileStatus').value;
            
            try {
                // Update Firebase
                await database.ref('users/' + currentUser.uid).update({
                    name: name,
                    bio: bio,
                    status: status
                });
                
                // Update local user
                currentUser.name = name;
                
                // Update UI
                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = getInitials(name);
                document.getElementById('profileName').textContent = name;
                document.getElementById('profileAvatar').textContent = getInitials(name);
                
                // Update Firebase Auth display name
                await auth.currentUser.updateProfile({
                    displayName: name
                });
                
                hideProfileModal();
                showNotification('Profile updated successfully!', 'success');
            } catch (error) {
                showNotification('Error updating profile: ' + error.message, 'error');
            }
        }

        // Show friend profile
        async function showFriendProfile() {
            if (!selectedUser) return;
            
            document.getElementById('friendProfileName').textContent = selectedUser.name;
            document.getElementById('friendProfileEmail').textContent = selectedUser.email;
            document.getElementById('friendProfileAvatar').textContent = getInitials(selectedUser.name);
            document.getElementById('friendProfileBio').textContent = selectedUser.bio || 'No bio available';
            document.getElementById('friendProfileStatus').textContent = selectedUser.status || 'No status available';
            
            const lastSeen = selectedUser.lastSeen ? new Date(selectedUser.lastSeen).toLocaleString() : 'Unknown';
            document.getElementById('friendProfileLastSeen').textContent = lastSeen;
            
            document.getElementById('friendProfileModal').style.display = 'flex';
        }

        // Hide friend profile modal
        function hideFriendProfileModal() {
            document.getElementById('friendProfileModal').style.display = 'none';
        }

        // Toggle online status
        async function toggleOnlineStatus() {
            const isOnline = document.getElementById('onlineStatus').checked;
            
            if (currentUser) {
                await database.ref('users/' + currentUser.uid).update({
                    online: isOnline,
                    lastSeen: isOnline ? null : firebase.database.ServerValue.TIMESTAMP
                });
                
                currentUser.online = isOnline;
            }
        }

        // Switch between login and register tabs
        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
            } else {
                tabs[1].classList.add('active');
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
            }
        }

        // Email/Password Login
        async function loginWithEmail() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Login successful!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Email/Password Register
        async function registerWithEmail() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({
                    displayName: name
                });
                showNotification('Registration successful!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Logout
        async function logout(event) {
            event.stopPropagation();
            
            if (currentUser) {
                await database.ref('users/' + currentUser.uid).update({
                    online: false,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            }
            await auth.signOut();
        }

        // Show main app
        function showApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            
            // Update user profile
            if (currentUser) {
                document.getElementById('userAvatar').textContent = getInitials(currentUser.name);
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('profileName').textContent = currentUser.name;
                document.getElementById('profileEmail').textContent = currentUser.email;
                document.getElementById('profileAvatar').textContent = getInitials(currentUser.name);
            }
        }

        // Show auth section
        function showAuth() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('appSection').style.display = 'none';
            currentUser = null;
            selectedUser = null;
        }

        // Get initials from name
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        // Switch between tabs
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab styles
            document.getElementById('friendsTab').classList.remove('active');
            document.getElementById('requestsTab').classList.remove('active');
            document.getElementById('searchTab').classList.remove('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // Load tab content
            if (tab === 'friends') {
                loadFriends();
            } else if (tab === 'requests') {
                loadFriendRequests();
            } else if (tab === 'search') {
                loadSearchUsers();
            }
        }

        // Load friends list
        function loadFriends() {
            database.ref('friendships').orderByChild(currentUser.uid + '/status').equalTo('accepted').on('value', (snapshot) => {
                const friendships = snapshot.val();
                const friendIds = [];
                
                if (friendships) {
                    Object.keys(friendships).forEach(key => {
                        const friendship = friendships[key];
                        if (friendship[currentUser.uid] && friendship[currentUser.uid].status === 'accepted') {
                            const otherId = Object.keys(friendship).find(id => id !== currentUser.uid);
                            if (otherId) friendIds.push(otherId);
                        }
                    });
                }
                
                loadUsersByIds(friendIds, 'friends');
            });
        }

        // Load friend requests
        function loadFriendRequests() {
            database.ref('friendRequests').orderByChild('to').equalTo(currentUser.uid).on('value', (snapshot) => {
                const requests = snapshot.val();
                const requestIds = [];
                const requestData = {};
                
                if (requests) {
                    Object.keys(requests).forEach(key => {
                        const request = requests[key];
                        if (request.status === 'pending') {
                            requestIds.push(request.from);
                            requestData[request.from] = key;
                        }
                    });
                }
                
                // Update badge
                const badge = document.getElementById('requestBadge');
                if (requestIds.length > 0) {
                    badge.style.display = 'inline';
                    badge.textContent = requestIds.length;
                } else {
                    badge.style.display = 'none';
                }
                
                loadUsersByIds(requestIds, 'requests', requestData);
            });
        }

        // Load search users (all users except self and friends)
        function loadSearchUsers() {
            database.ref('users').once('value', (snapshot) => {
                const users = snapshot.val();
                const allUsers = [];
                
                // First, get friends
                database.ref('friendships').orderByChild(currentUser.uid + '/status').equalTo('accepted').once('value', (friendsSnapshot) => {
                    const friendships = friendsSnapshot.val();
                    const friendIds = [];
                    
                    if (friendships) {
                        Object.keys(friendships).forEach(key => {
                            const friendship = friendships[key];
                            if (friendship[currentUser.uid] && friendship[currentUser.uid].status === 'accepted') {
                                const otherId = Object.keys(friendship).find(id => id !== currentUser.uid);
                                if (otherId) friendIds.push(otherId);
                            }
                        });
                    }
                    
                    // Get pending requests
                    database.ref('friendRequests').orderByChild('from').equalTo(currentUser.uid).once('value', (sentSnapshot) => {
                        const sentRequests = sentSnapshot.val();
                        const pendingIds = [];
                        
                        if (sentRequests) {
                            Object.keys(sentRequests).forEach(key => {
                                if (sentRequests[key].status === 'pending') {
                                    pendingIds.push(sentRequests[key].to);
                                }
                            });
                        }
                        
                        // Filter users
                        Object.keys(users).forEach(uid => {
                            if (uid !== currentUser.uid && 
                                !friendIds.includes(uid) && 
                                !pendingIds.includes(uid)) {
                                allUsers.push({
                                    uid: uid,
                                    ...users[uid]
                                });
                            }
                        });
                        
                        displayUsers(allUsers, 'search');
                    });
                });
            });
        }

        // Load users by IDs
        function loadUsersByIds(userIds, type, requestData = {}) {
            if (userIds.length === 0) {
                displayUsers([], type);
                return;
            }
            
            const users = [];
            let loaded = 0;
            
            userIds.forEach(uid => {
                database.ref('users/' + uid).once('value', (snapshot) => {
                    const user = snapshot.val();
                    if (user) {
                        users.push({
                            uid: uid,
                            ...user,
                            requestKey: requestData[uid]
                        });
                    }
                    
                    loaded++;
                    if (loaded === userIds.length) {
                        displayUsers(users, type);
                    }
                });
            });
        }

        // Display users in tab content
        function displayUsers(users, type) {
            const tabContent = document.getElementById('tabContent');
            
            if (users.length === 0) {
                if (type === 'friends') {
                    tabContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No friends yet. Add some friends!</div>';
                } else if (type === 'requests') {
                    tabContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No pending friend requests</div>';
                } else {
                    tabContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No users found</div>';
                }
                return;
            }
            
            let html = '';
            users.forEach(user => {
                const isOnline = user.online ? '' : 'offline';
                const lastSeen = user.lastSeen ? new Date(user.lastSeen).toLocaleString() : 'Unknown';
                const statusText = user.status ? ` - ${user.status}` : '';
                
                if (type === 'friends') {
                    html += `
                        <div class="user-item" onclick="selectUser('${user.uid}')">
                            <div class="avatar">${getInitials(user.name)}</div>
                            <div>
                                <h4>${user.name}</h4>
                                <p style="font-size: 12px; color: #666;">${user.email}${statusText}</p>
                            </div>
                            <div class="user-status ${isOnline}" title="Last seen: ${lastSeen}"></div>
                        </div>
                    `;
                } else if (type === 'requests') {
                    html += `
                        <div class="user-item">
                            <div class="avatar">${getInitials(user.name)}</div>
                            <div>
                                <h4>${user.name}</h4>
                                <p style="font-size: 12px; color: #666;">${user.email}</p>
                            </div>
                            <div class="friend-request-actions">
                                <button class="accept-btn-small" onclick="acceptFriendRequest('${user.uid}', '${user.requestKey}')">‚úì Accept</button>
                                <button class="reject-btn-small" onclick="rejectFriendRequest('${user.uid}', '${user.requestKey}')">‚úó Reject</button>
                            </div>
                        </div>
                    `;
                } else if (type === 'search') {
                    html += `
                        <div class="user-item">
                            <div class="avatar">${getInitials(user.name)}</div>
                            <div>
                                <h4>${user.name}</h4>
                                <p style="font-size: 12px; color: #666;">${user.email}</p>
                            </div>
                            <button class="add-friend-btn" onclick="sendFriendRequest('${user.uid}')">+ Add Friend</button>
                        </div>
                    `;
                }
            });
            
            tabContent.innerHTML = html;
        }

        // Send friend request
        async function sendFriendRequest(toUid) {
            try {
                const requestRef = database.ref('friendRequests').push();
                await requestRef.set({
                    from: currentUser.uid,
                    to: toUid,
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                showNotification('Friend request sent!', 'success');
                loadSearchUsers(); // Refresh search
            } catch (error) {
                showNotification('Error sending friend request', 'error');
            }
        }

        // Accept friend request
        async function acceptFriendRequest(fromUid, requestKey) {
            try {
                // Update request status
                await database.ref('friendRequests/' + requestKey).update({
                    status: 'accepted'
                });
                
                // Create friendship
                const friendshipId = [currentUser.uid, fromUid].sort().join('_');
                await database.ref('friendships/' + friendshipId).set({
                    [currentUser.uid]: {
                        status: 'accepted',
                        since: firebase.database.ServerValue.TIMESTAMP
                    },
                    [fromUid]: {
                        status: 'accepted',
                        since: firebase.database.ServerValue.TIMESTAMP
                    }
                });
                
                showNotification('Friend request accepted!', 'success');
                loadFriendRequests(); // Refresh requests
            } catch (error) {
                showNotification('Error accepting friend request', 'error');
            }
        }

        // Reject friend request
        async function rejectFriendRequest(fromUid, requestKey) {
            try {
                await database.ref('friendRequests/' + requestKey).remove();
                showNotification('Friend request rejected', 'info');
                loadFriendRequests(); // Refresh requests
            } catch (error) {
                showNotification('Error rejecting friend request', 'error');
            }
        }

        // Listen for friend requests
        function listenForFriendRequests() {
            database.ref('friendRequests').orderByChild('to').equalTo(currentUser.uid).on('value', (snapshot) => {
                const requests = snapshot.val();
                let count = 0;
                
                if (requests) {
                    Object.keys(requests).forEach(key => {
                        if (requests[key].status === 'pending') {
                            count++;
                        }
                    });
                }
                
                // Update badge
                const badge = document.getElementById('requestBadge');
                if (count > 0) {
                    badge.style.display = 'inline';
                    badge.textContent = count;
                } else {
                    badge.style.display = 'none';
                }
            });
        }

        // Select user to chat with
        function selectUser(uid) {
            database.ref('users/' + uid).once('value', (snapshot) => {
                selectedUser = {
                    uid: uid,
                    ...snapshot.val()
                };
                
                // Create or get chat room
                const chatId = [currentUser.uid, uid].sort().join('_');
                currentChatId = chatId;
                
                // Create chat room if it doesn't exist
                database.ref('chats/' + chatId).set({
                    participants: {
                        [currentUser.uid]: true,
                        [uid]: true
                    },
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Update UI
                document.getElementById('chatUserAvatar').textContent = getInitials(selectedUser.name);
                document.getElementById('chatUserName').textContent = selectedUser.name;
                document.getElementById('chatUserStatus').textContent = selectedUser.online ? 'Online' : 'Offline';
                
                // Enable chat controls
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('videoCallBtn').disabled = false;
                document.getElementById('audioCallBtn').disabled = false;
                document.getElementById('imageUploadBtn').disabled = false;
                
                // Load messages
                loadMessages();
            });
        }

        // Load messages
        function loadMessages() {
            if (!currentChatId) return;
            
            const messagesRef = database.ref('messages/' + currentChatId).orderByChild('timestamp');
            
            messagesRef.off(); // Remove previous listener
            messagesRef.on('value', (snapshot) => {
                const messages = snapshot.val();
                const chatMessages = document.getElementById('chatMessages');
                
                if (!messages) {
                    chatMessages.innerHTML = '<div style="text-align: center; color: #999; margin-top: 50px;">No messages yet. Start a conversation!</div>';
                    return;
                }
                
                let html = '';
                Object.keys(messages).sort((a, b) => messages[a].timestamp - messages[b].timestamp).forEach(key => {
                    const msg = messages[key];
                    const isSent = msg.sender === currentUser.uid;
                    
                    if (msg.type === 'image') {
                        html += `
                            <div class="message ${isSent ? 'sent' : ''}">
                                <div class="message-content">
                                    <img src="${msg.imageUrl}" class="message-image" onclick="showImagePreview('${msg.imageUrl}')" alt="Image">
                                    <div class="message-time">${formatTime(msg.timestamp)}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="message ${isSent ? 'sent' : ''}">
                                <div class="message-content">
                                    ${msg.text}
                                    <div class="message-time">${formatTime(msg.timestamp)}</div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                chatMessages.innerHTML = html;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        // Format timestamp
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Send message
        async function sendMessage() {
            if (!selectedUser || !currentChatId) {
                showNotification('Please select a friend to chat with', 'warning');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Save message to Firebase
            const messageRef = database.ref('messages/' + currentChatId).push();
            await messageRef.set({
                sender: currentUser.uid,
                receiver: selectedUser.uid,
                text: text,
                type: 'text',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Clear input
            input.value = '';
        }

        // Send image
        async function sendImage() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            if (!selectedUser || !currentChatId) {
                showNotification('Please select a friend to chat with', 'warning');
                return;
            }
            
            try {
                showNotification('Uploading image...', 'info');
                
                // Upload to Firebase Storage
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`chat_images/${currentChatId}/${Date.now()}_${file.name}`);
                await imageRef.put(file);
                
                // Get download URL
                const imageUrl = await imageRef.getDownloadURL();
                
                // Save message to Firebase
                const messageRef = database.ref('messages/' + currentChatId).push();
                await messageRef.set({
                    sender: currentUser.uid,
                    receiver: selectedUser.uid,
                    imageUrl: imageUrl,
                    type: 'image',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Clear input
                fileInput.value = '';
                
                showNotification('Image sent!', 'success');
            } catch (error) {
                console.error('Error sending image:', error);
                showNotification('Failed to send image: ' + error.message, 'error');
            }
        }

        // Show image preview
        function showImagePreview(imageUrl) {
            document.getElementById('previewImage').src = imageUrl;
            document.getElementById('imagePreviewModal').style.display = 'flex';
        }

        // Hide image preview
        function hideImagePreview() {
            document.getElementById('imagePreviewModal').style.display = 'none';
        }

        // Handle enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Video/Audio call functions
        async function startVideoCall() {
            if (!selectedUser) {
                showNotification('Please select a friend to call', 'warning');
                return;
            }
            
            callType = 'video';
            await initializeCall();
        }

        async function startAudioCall() {
            if (!selectedUser) {
                showNotification('Please select a friend to call', 'warning');
                return;
            }
            
            callType = 'audio';
            await initializeCall();
        }

        async function initializeCall() {
            try {
                // Get user media
                const constraints = {
                    video: callType === 'video',
                    audio: true
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('localVideo').srcObject = localStream;
                
                // Show video modal
                document.getElementById('videoModal').style.display = 'block';
                
                // Create call document in Firebase
                callDocId = Date.now().toString();
                await database.ref('calls/' + callDocId).set({
                    caller: currentUser.uid,
                    callee: selectedUser.uid,
                    type: callType,
                    status: 'ringing',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Create peer connection
                peerConnection = new RTCPeerConnection(configuration);
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        database.ref('calls/' + callDocId + '/iceCandidates/' + currentUser.uid).push(event.candidate);
                    }
                };
                
                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Save offer to Firebase
                await database.ref('calls/' + callDocId + '/offer').set({
                    type: offer.type,
                    sdp: offer.sdp
                });
                
                isCallActive = true;
                
            } catch (error) {
                console.error('Error initializing call:', error);
                showNotification('Failed to initialize call: ' + error.message, 'error');
                endCall();
            }
        }

        // Listen for incoming calls
        function listenForCalls() {
            if (!currentUser) return;
            
            database.ref('calls').orderByChild('callee').equalTo(currentUser.uid).on('child_added', (snapshot) => {
                const call = snapshot.val();
                
                if (call.status === 'ringing' && call.callee === currentUser.uid) {
                    // Get caller info
                    database.ref('users/' + call.caller).once('value', (userSnapshot) => {
                        const caller = userSnapshot.val();
                        
                        incomingCall = {
                            id: snapshot.key,
                            caller: call.caller,
                            callee: call.callee,
                            type: call.type,
                            callerInfo: caller
                        };
                        
                        document.getElementById('incomingCaller').textContent = `${caller.name} is calling...`;
                        document.getElementById('callType').textContent = call.type === 'video' ? 'üìπ Video Call' : 'üé§ Audio Call';
                        document.getElementById('incomingCallModal').style.display = 'block';
                    });
                }
            });
        }

        async function acceptCall() {
            if (!incomingCall) return;
            
            document.getElementById('incomingCallModal').style.display = 'none';
            
            try {
                // Update call status
                await database.ref('calls/' + incomingCall.id).update({
                    status: 'connected'
                });
                
                // Get user media
                const constraints = {
                    video: incomingCall.type === 'video',
                    audio: true
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('localVideo').srcObject = localStream;
                
                // Show video modal
                document.getElementById('videoModal').style.display = 'block';
                document.getElementById('remoteVideoLabel').textContent = incomingCall.callerInfo.name;
                
                // Create peer connection
                peerConnection = new RTCPeerConnection(configuration);
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        database.ref('calls/' + incomingCall.id + '/iceCandidates/' + currentUser.uid).push(event.candidate);
                    }
                };
                
                // Get offer from Firebase
                const callSnapshot = await database.ref('calls/' + incomingCall.id).once('value');
                const call = callSnapshot.val();
                
                if (call.offer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(call.offer));
                    
                    // Create answer
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    // Save answer to Firebase
                    await database.ref('calls/' + incomingCall.id + '/answer').set({
                        type: answer.type,
                        sdp: answer.sdp
                    });
                }
                
                // Listen for ICE candidates from caller
                database.ref('calls/' + incomingCall.id + '/iceCandidates/' + incomingCall.caller).on('child_added', (snapshot) => {
                    const candidate = snapshot.val();
                    if (peerConnection) {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    }
                });
                
                isCallActive = true;
                
            } catch (error) {
                console.error('Error accepting call:', error);
                showNotification('Failed to accept call', 'error');
                endCall();
            }
        }

        function rejectCall() {
            if (incomingCall) {
                database.ref('calls/' + incomingCall.id).update({
                    status: 'rejected'
                });
            }
            document.getElementById('incomingCallModal').style.display = 'none';
            incomingCall = null;
            showNotification('Call rejected');
        }

        function endCall() {
            // Close peer connection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Update call status in Firebase
            if (callDocId) {
                database.ref('calls/' + callDocId).update({
                    status: 'ended',
                    endedAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            // Hide video modal
            document.getElementById('videoModal').style.display = 'none';
            
            isCallActive = false;
            callDocId = null;
            showNotification('Call ended');
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    document.getElementById('muteBtn').style.opacity = audioTrack.enabled ? '1' : '0.5';
                }
            }
        }

        function toggleVideo() {
            if (localStream && callType === 'video') {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    document.getElementById('videoBtn').style.opacity = videoTrack.enabled ? '1' : '0.5';
                }
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'error' ? '#f44336' : 
                                          type === 'success' ? '#4caf50' : 
                                          type === 'warning' ? '#ff9800' : '#333';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
